<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HR Dashboard - AHKF</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700;800&display=swap');

        /* Modern Orange Theme */
        :root {
            --primary-orange: #FF6B35;
            --secondary-orange: #F7931E;
            --deep-orange: #E85D04;
            --light-orange: #FFB08A;
            --cream-bg: #FFF8F3;
            --card-white: #FFFFFF;
            --text-dark: #2D3142;
            --text-light: #6B7280;
            --border-light: #FFE5D9;
            --success: #10B981;
            --warning: #F59E0B;
            --danger: #EF4444;
            
            /* Spacing */
            --space-xs: 0.5rem;
            --space-sm: 1rem;
            --space-md: 1.5rem;
            --space-lg: 2rem;
            --space-xl: 3rem;
            
            /* Borders */
            --radius-sm: 0.75rem;
            --radius-md: 1rem;
            --radius-lg: 1.5rem;
            --radius-xl: 2rem;
            
            /* Shadows */
            --shadow-sm: 0 2px 8px rgba(255, 107, 53, 0.08);
            --shadow-md: 0 4px 16px rgba(255, 107, 53, 0.12);
            --shadow-lg: 0 8px 32px rgba(255, 107, 53, 0.16);
            --shadow-xl: 0 12px 48px rgba(255, 107, 53, 0.2);
        }

        body.dark-theme {
            --primary-orange: #FF8C5F;
            --cream-bg: #0F172A;
            --card-white: #1E293B;
            --text-dark: #F1F5F9;
            --text-light: #94A3B8;
            --border-light: #334155;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Poppins', sans-serif;
            background: var(--cream-bg);
            color: var(--text-dark);
            transition: all 0.3s ease;
        }

        /* TOP NAVIGATION BAR - New Design */
        .top-navbar {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            height: 80px;
            background: var(--card-white);
            backdrop-filter: blur(20px);
            border-bottom: 2px solid var(--border-light);
            z-index: 1000;
            display: flex;
            align-items: center;
            padding: 0 var(--space-xl);
            box-shadow: var(--shadow-sm);
        }

        .navbar-brand {
            display: flex;
            align-items: center;
            gap: var(--space-md);
        }

        .brand-logo {
            width: 50px;
            height: 50px;
            background: linear-gradient(135deg, var(--primary-orange), var(--deep-orange));
            border-radius: var(--radius-md);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 1.5rem;
            font-weight: 700;
        }

        .brand-text h1 {
            font-size: 1.25rem;
            font-weight: 700;
            background: linear-gradient(135deg, var(--primary-orange), var(--deep-orange));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            line-height: 1.2;
        }

        .brand-text p {
            font-size: 0.75rem;
            color: var(--text-light);
            font-weight: 500;
        }

        .nav-menu {
            display: flex;
            gap: var(--space-sm);
            margin-left: auto;
            margin-right: auto;
        }

        .nav-link {
            display: flex;
            align-items: center;
            gap: var(--space-xs);
            padding: var(--space-sm) var(--space-md);
            border-radius: var(--radius-md);
            color: var(--text-light);
            text-decoration: none;
            font-weight: 500;
            font-size: 0.95rem;
            transition: all 0.3s ease;
            position: relative;
        }

        .nav-link:hover {
            background: rgba(255, 107, 53, 0.08);
            color: var(--primary-orange);
            transform: translateY(-2px);
        }

        .nav-link.active {
            background: linear-gradient(135deg, var(--primary-orange), var(--deep-orange));
            color: white;
            box-shadow: var(--shadow-md);
        }

        .nav-link.active i {
            animation: bounce 0.5s ease;
        }

        .nav-controls {
            display: flex;
            gap: var(--space-sm);
            align-items: center;
        }

        .control-btn {
            width: 44px;
            height: 44px;
            border-radius: var(--radius-md);
            border: 2px solid var(--border-light);
            background: var(--card-white);
            color: var(--primary-orange);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.1rem;
            transition: all 0.3s ease;
        }

        .control-btn:hover {
            background: linear-gradient(135deg, var(--primary-orange), var(--deep-orange));
            color: white;
            border-color: transparent;
            transform: scale(1.05);
        }

        .refresh-btn {
            padding: var(--space-sm) var(--space-md);
            border-radius: var(--radius-md);
            border: none;
            background: linear-gradient(135deg, var(--primary-orange), var(--deep-orange));
            color: white;
            font-weight: 600;
            font-size: 0.9rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: var(--space-xs);
            transition: all 0.3s ease;
            box-shadow: var(--shadow-sm);
        }

        .refresh-btn:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
        }

        .refresh-btn.loading i {
            animation: spin 1s linear infinite;
        }

        /* MAIN CONTENT AREA */
        .main-container {
            margin-top: 80px;
            padding: var(--space-xl);
            max-width: 1600px;
            margin-left: auto;
            margin-right: auto;
        }

        .page-header {
            margin-bottom: var(--space-xl);
        }

        .page-title {
            font-size: 2.5rem;
            font-weight: 800;
            background: linear-gradient(135deg, var(--primary-orange), var(--deep-orange));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: var(--space-xs);
        }

        .page-subtitle {
            font-size: 1.1rem;
            color: var(--text-light);
            font-weight: 400;
        }

        /* HERO STATS SECTION - New Design */
        .hero-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: var(--space-lg);
            margin-bottom: var(--space-xl);
        }

        .stat-card {
            background: var(--card-white);
            border-radius: var(--radius-lg);
            padding: var(--space-lg);
            box-shadow: var(--shadow-md);
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
            cursor: pointer;
        }

        .stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 5px;
            background: linear-gradient(90deg, var(--primary-orange), var(--secondary-orange), var(--deep-orange));
        }

        .stat-card:hover {
            transform: translateY(-8px) scale(1.02);
            box-shadow: var(--shadow-xl);
        }

        .stat-card-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: var(--space-md);
        }

        .stat-icon {
            width: 60px;
            height: 60px;
            border-radius: var(--radius-md);
            background: linear-gradient(135deg, rgba(255, 107, 53, 0.1), rgba(232, 93, 4, 0.05));
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.8rem;
            color: var(--primary-orange);
        }

        .stat-value {
            font-size: 2.75rem;
            font-weight: 800;
            color: var(--primary-orange);
            line-height: 1;
            margin-bottom: var(--space-xs);
        }

        .stat-label {
            font-size: 0.95rem;
            color: var(--text-light);
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .stat-trend {
            display: flex;
            align-items: center;
            gap: var(--space-xs);
            font-size: 0.85rem;
            margin-top: var(--space-sm);
        }

        .trend-up {
            color: var(--success);
        }

        .trend-down {
            color: var(--danger);
        }

        /* SECTION HEADERS */
        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: var(--space-lg);
        }

        .section-title {
            font-size: 1.75rem;
            font-weight: 700;
            color: var(--text-dark);
        }

        .section-title::before {
            content: '';
            display: inline-block;
            width: 6px;
            height: 28px;
            background: linear-gradient(180deg, var(--primary-orange), var(--deep-orange));
            border-radius: 3px;
            margin-right: var(--space-sm);
            vertical-align: middle;
        }

        /* MODERN CARD GRID */
        .card-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: var(--space-lg);
            margin-bottom: var(--space-xl);
        }

        .info-card {
            background: var(--card-white);
            border-radius: var(--radius-lg);
            padding: var(--space-lg);
            box-shadow: var(--shadow-sm);
            transition: all 0.3s ease;
            cursor: pointer;
            position: relative;
            overflow: hidden;
        }

        .info-card::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, var(--primary-orange), var(--deep-orange));
            transform: scaleX(0);
            transform-origin: left;
            transition: transform 0.3s ease;
        }

        .info-card:hover::after {
            transform: scaleX(1);
        }

        .info-card:hover {
            transform: translateY(-5px);
            box-shadow: var(--shadow-lg);
        }

        .card-icon-container {
            width: 50px;
            height: 50px;
            border-radius: var(--radius-sm);
            background: rgba(255, 107, 53, 0.1);
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: var(--space-md);
            font-size: 1.5rem;
            color: var(--primary-orange);
        }

        .card-value {
            font-size: 2.25rem;
            font-weight: 700;
            color: var(--primary-orange);
            margin-bottom: var(--space-xs);
        }

        .card-label {
            font-size: 0.9rem;
            color: var(--text-light);
            font-weight: 500;
        }

        /* WIDE CARDS FOR CHARTS */
        .chart-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(500px, 1fr));
            gap: var(--space-lg);
            margin-bottom: var(--space-xl);
        }

        .chart-card {
            background: var(--card-white);
            border-radius: var(--radius-lg);
            padding: var(--space-lg);
            box-shadow: var(--shadow-md);
        }

        .chart-card-title {
            font-size: 1.2rem;
            font-weight: 600;
            color: var(--text-dark);
            margin-bottom: var(--space-md);
        }

        /* TABLES */
        .table-card {
            background: var(--card-white);
            border-radius: var(--radius-lg);
            padding: var(--space-lg);
            box-shadow: var(--shadow-md);
            margin-bottom: var(--space-xl);
        }

        .table-responsive {
            overflow-x: auto;
        }

        .data-table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0 8px;
        }

        .data-table thead th {
            background: linear-gradient(135deg, rgba(255, 107, 53, 0.1), rgba(232, 93, 4, 0.05));
            color: var(--primary-orange);
            text-transform: uppercase;
            font-size: 0.8rem;
            font-weight: 600;
            letter-spacing: 0.5px;
            padding: var(--space-md);
            text-align: left;
        }

        .data-table tbody tr {
            background: var(--card-white);
            transition: all 0.3s ease;
        }

        .data-table tbody tr:hover {
            transform: scale(1.01);
            box-shadow: var(--shadow-sm);
        }

        .data-table tbody td {
            padding: var(--space-md);
            border-top: 1px solid var(--border-light);
            border-bottom: 1px solid var(--border-light);
        }

        .data-table tbody td:first-child {
            border-left: 1px solid var(--border-light);
            border-radius: var(--radius-sm) 0 0 var(--radius-sm);
        }

        .data-table tbody td:last-child {
            border-right: 1px solid var(--border-light);
            border-radius: 0 var(--radius-sm) var(--radius-sm) 0;
        }

        /* FILTER BAR */
        .filter-bar {
            display: flex;
            gap: var(--space-md);
            margin-bottom: var(--space-lg);
            flex-wrap: wrap;
            align-items: center;
        }

        .search-box {
            flex: 1;
            min-width: 300px;
            position: relative;
        }

        .search-box input {
            width: 100%;
            padding: var(--space-md) var(--space-md) var(--space-md) 3rem;
            border: 2px solid var(--border-light);
            border-radius: var(--radius-md);
            font-family: 'Poppins', sans-serif;
            font-size: 0.95rem;
            transition: all 0.3s ease;
        }

        .search-box input:focus {
            outline: none;
            border-color: var(--primary-orange);
            box-shadow: 0 0 0 4px rgba(255, 107, 53, 0.1);
        }

        .search-box i {
            position: absolute;
            left: var(--space-md);
            top: 50%;
            transform: translateY(-50%);
            color: var(--primary-orange);
            font-size: 1.2rem;
        }

        .filter-select {
            padding: var(--space-md);
            border: 2px solid var(--border-light);
            border-radius: var(--radius-md);
            font-family: 'Poppins', sans-serif;
            font-size: 0.95rem;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .filter-select:focus {
            outline: none;
            border-color: var(--primary-orange);
        }

        /* MODALS */
        .login-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, var(--primary-orange), var(--deep-orange), var(--secondary-orange));
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 10000;
        }

        .login-overlay.hidden {
            display: none;
        }

        .login-box {
            background: white;
            padding: 3rem 2.5rem;
            border-radius: var(--radius-xl);
            box-shadow: var(--shadow-xl);
            max-width: 450px;
            width: 90%;
            text-align: center;
        }

        .login-box h1 {
            font-size: 2.5rem;
            margin-bottom: var(--space-sm);
            background: linear-gradient(135deg, var(--primary-orange), var(--deep-orange));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .login-box p {
            color: var(--text-light);
            margin-bottom: var(--space-xl);
            font-size: 1rem;
        }

        .login-form {
            display: flex;
            flex-direction: column;
            gap: var(--space-md);
        }

        .login-input {
            padding: var(--space-md);
            border: 2px solid var(--border-light);
            border-radius: var(--radius-md);
            font-family: 'Poppins', sans-serif;
            font-size: 1rem;
            transition: all 0.3s;
        }

        .login-input:focus {
            outline: none;
            border-color: var(--primary-orange);
            box-shadow: 0 0 0 4px rgba(255, 107, 53, 0.1);
        }

        .login-button {
            padding: var(--space-md);
            background: linear-gradient(135deg, var(--primary-orange), var(--deep-orange));
            color: white;
            border: none;
            border-radius: var(--radius-md);
            font-family: 'Poppins', sans-serif;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        .login-button:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
        }

        .login-error {
            color: var(--danger);
            font-size: 0.9rem;
            display: none;
            margin-top: -var(--space-sm);
        }

        .login-error.show {
            display: block;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(8px);
            z-index: 2000;
            justify-content: center;
            align-items: center;
        }

        .modal-content {
            background: var(--card-white);
            border-radius: var(--radius-xl);
            padding: var(--space-xl);
            max-width: 800px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: var(--shadow-xl);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: var(--space-lg);
            padding-bottom: var(--space-md);
            border-bottom: 2px solid var(--border-light);
        }

        .modal-header h3 {
            font-size: 1.75rem;
            color: var(--primary-orange);
            font-weight: 700;
        }

        .close-modal {
            width: 40px;
            height: 40px;
            border-radius: var(--radius-sm);
            background: rgba(255, 107, 53, 0.1);
            color: var(--primary-orange);
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            transition: all 0.3s;
        }

        .close-modal:hover {
            background: var(--primary-orange);
            color: white;
            transform: rotate(90deg);
        }

        /* FORMS */
        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: var(--space-md);
        }

        .form-group {
            margin-bottom: var(--space-md);
        }

        .form-group label {
            display: block;
            margin-bottom: var(--space-xs);
            font-weight: 600;
            color: var(--text-dark);
            font-size: 0.9rem;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: var(--space-md);
            border: 2px solid var(--border-light);
            border-radius: var(--radius-md);
            font-family: 'Poppins', sans-serif;
            font-size: 0.95rem;
            transition: all 0.3s;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: var(--primary-orange);
            box-shadow: 0 0 0 4px rgba(255, 107, 53, 0.1);
        }

        /* BUTTONS */
        .btn {
            padding: var(--space-md) var(--space-lg);
            border-radius: var(--radius-md);
            border: none;
            font-family: 'Poppins', sans-serif;
            font-weight: 600;
            font-size: 0.95rem;
            cursor: pointer;
            transition: all 0.3s;
            display: inline-flex;
            align-items: center;
            gap: var(--space-xs);
        }

        .btn.primary {
            background: linear-gradient(135deg, var(--primary-orange), var(--deep-orange));
            color: white;
            box-shadow: var(--shadow-sm);
        }

        .btn.primary:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
        }

        .btn.secondary {
            background: var(--border-light);
            color: var(--primary-orange);
        }

        .btn.secondary:hover {
            background: var(--primary-orange);
            color: white;
        }

        /* BADGES */
        .badge {
            display: inline-block;
            padding: 0.35rem 0.75rem;
            border-radius: 50px;
            font-size: 0.8rem;
            font-weight: 600;
        }

        .badge-active {
            background: rgba(16, 185, 129, 0.15);
            color: var(--success);
        }

        .badge-inactive {
            background: rgba(239, 68, 68, 0.15);
            color: var(--danger);
        }

        /* ANIMATIONS */
        @keyframes bounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-5px); }
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .fade-in-up {
            animation: fadeInUp 0.6s ease-out;
        }

        /* PAGE VISIBILITY */
        .page {
            display: none;
        }

        .page.active {
            display: block;
            animation: fadeInUp 0.6s ease-out;
        }

        /* RESPONSIVE */
        @media (max-width: 768px) {
            .top-navbar {
                padding: 0 var(--space-md);
                height: auto;
                flex-wrap: wrap;
                padding-top: var(--space-md);
                padding-bottom: var(--space-md);
            }

            .nav-menu {
                order: 3;
                width: 100%;
                margin-top: var(--space-md);
                justify-content: space-around;
            }

            .nav-link span {
                display: none;
            }

            .main-container {
                padding: var(--space-md);
            }

            .page-title {
                font-size: 1.75rem;
            }

            .hero-stats,
            .card-grid,
            .chart-grid {
                grid-template-columns: 1fr;
            }

            .chart-grid {
                grid-template-columns: 1fr;
            }
        }

        /* PROFILE PIC */
        .profile-pic-container {
            text-align: center;
            margin: var(--space-lg) 0;
        }

        .profile-pic-preview {
            width: 120px;
            height: 120px;
            border-radius: 50%;
            object-fit: cover;
            border: 4px solid var(--primary-orange);
            display: none;
            margin: 0 auto var(--space-md);
            box-shadow: var(--shadow-md);
        }

        /* TABLE ACTIONS */
        .table-actions {
            display: flex;
            gap: var(--space-xs);
        }

        .table-actions button {
            width: 36px;
            height: 36px;
            border-radius: var(--radius-sm);
            border: none;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .table-actions button:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-sm);
        }

        .status-badge {
            padding: 0.35rem 0.85rem;
            border-radius: 50px;
            font-size: 0.8rem;
            font-weight: 600;
            display: inline-block;
        }

        /* METRIC CARDS */
        .metric-content {
            flex: 1;
        }

        .metric-icon-container {
            font-size: 2.5rem;
            color: rgba(255, 107, 53, 0.2);
        }

        .clickable-card {
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .clickable-card:hover {
            transform: translateY(-5px);
            box-shadow: var(--shadow-lg);
        }

        .clickable-card:active {
            transform: translateY(-2px);
        }

        .card {
            background: var(--card-white);
            border-radius: var(--radius-lg);
            padding: var(--space-lg);
            box-shadow: var(--shadow-sm);
            transition: all 0.3s;
        }

        .value {
            font-size: 2.5rem;
            font-weight: 700;
            color: var(--primary-orange);
            line-height: 1;
        }

        /* TAB STYLES */
        .tab-buttons {
            display: flex;
            gap: var(--space-sm);
            margin-bottom: var(--space-lg);
            border-bottom: 2px solid var(--border-light);
        }

        .tab-button {
            padding: var(--space-md) var(--space-lg);
            border: none;
            background: none;
            font-family: 'Poppins', sans-serif;
            font-weight: 600;
            font-size: 0.95rem;
            color: var(--text-light);
            cursor: pointer;
            border-bottom: 3px solid transparent;
            margin-bottom: -2px;
            transition: all 0.3s;
        }

        .tab-button.active {
            color: var(--primary-orange);
            border-bottom-color: var(--primary-orange);
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        /* DEPARTMENT GRID */
        #department-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: var(--space-md);
        }

        /* ADDITIONAL STYLES */
        .details-item {
            margin-bottom: var(--space-md);
        }

        .details-item strong {
            color: var(--text-dark);
            display: block;
            margin-bottom: var(--space-xs);
        }

        .details-item p {
            color: var(--text-light);
        }

        .action-buttons {
            display: flex;
            gap: var(--space-sm);
            margin-top: var(--space-lg);
        }

        .toggle-button {
            width: 44px;
            height: 44px;
            border-radius: var(--radius-md);
            border: 2px solid var(--border-light);
            background: var(--card-white);
            color: var(--primary-orange);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.1rem;
            transition: all 0.3s ease;
        }

        .toggle-button:hover {
            background: linear-gradient(135deg, var(--primary-orange), var(--deep-orange));
            color: white;
            border-color: transparent;
        }
    </style>
</head>
<body>
    <!-- Password Protection Overlay -->
    <div class="login-overlay" id="loginOverlay">
        <div class="login-box">
            <h1>üîê HR Dashboard</h1>
            <p>ANDAAZ-E-HUNAR</p>
            <form class="login-form" id="loginForm">
                <input 
                    type="password" 
                    class="login-input" 
                    id="passwordInput" 
                    placeholder="Enter Password"
                    required
                    autocomplete="off"
                />
                <div class="login-error" id="loginError">‚ùå Incorrect password. Please try again.</div>
                <button type="submit" class="login-button">
                    <i class="fas fa-sign-in-alt"></i> Login
                </button>
            </form>
            <p style="margin-top: 20px; font-size: 12px; color: #999;">
                Session expires when browser is closed
            </p>
        </div>
    </div>

    <!-- Top Navigation Bar -->
    <nav class="top-navbar">
        <div class="navbar-brand">
            <div class="brand-logo">
                <i class="fas fa-users-cog"></i>
            </div>
            <div class="brand-text">
                <h1>ANDAAZ_EHUNAR</h1>
                <p>Human Resources Dashboard</p>
            </div>
        </div>

        <div class="nav-menu">
            <a href="#dashboard" class="nav-link active" data-page="dashboard">
                <i class="fas fa-home"></i>
                <span>Dashboard</span>
            </a>
            <a href="#employees" class="nav-link" data-page="employees">
                <i class="fas fa-users"></i>
                <span>Employees</span>
            </a>
            <a href="#payroll" class="nav-link" data-page="payroll">
                <i class="fas fa-money-check-alt"></i>
                <span>Payroll</span>
            </a>
            <a href="#departments" class="nav-link" data-page="departments">
                <i class="fas fa-sitemap"></i>
                <span>Departments</span>
            </a>
            <a href="#reports" class="nav-link" data-page="reports">
                <i class="fas fa-chart-line"></i>
                <span>Reports</span>
            </a>
        </div>

        <div class="nav-controls">
            <button id="refresh-data-btn" class="refresh-btn" onclick="loadDataFromGoogleSheets()">
                <i class="fas fa-sync-alt"></i>
                Refresh Data
            </button>
            <button id="theme-toggle" class="control-btn toggle-button">
                <i class="fas fa-moon"></i>
            </button>
            <button class="control-btn" onclick="logout()" title="Logout">
                <i class="fas fa-sign-out-alt"></i>
            </button>
        </div>
    </nav>

    <!-- Main Content -->
    <main class="main-container">
        <!-- Dashboard Page -->
        <section id="dashboard" class="page active">
            <div class="page-header">
                <h1 class="page-title" id="page-title">Dashboard Overview</h1>
                <p class="page-subtitle">Complete HR analytics at a glance</p>
            </div>

            <!-- Hero Stats -->
            <div class="hero-stats">
                <div class="stat-card clickable-card" onclick="showMetricDetails('total-employees')">
                    <div class="stat-card-header">
                        <div>
                            <div class="stat-value" id="total-employees">0</div>
                            <div class="stat-label">Total Employees</div>
                        </div>
                        <div class="stat-icon">
                            <i class="fas fa-users"></i>
                        </div>
                    </div>
                </div>

                <div class="stat-card clickable-card" onclick="showMetricDetails('active-employees')">
                    <div class="stat-card-header">
                        <div>
                            <div class="stat-value" id="active-employees">0</div>
                            <div class="stat-label">Active Employees</div>
                        </div>
                        <div class="stat-icon">
                            <i class="fas fa-user-check"></i>
                        </div>
                    </div>
                </div>

                <div class="stat-card clickable-card" onclick="showMetricDetails('total-payroll')">
                    <div class="stat-card-header">
                        <div>
                            <div class="stat-value" id="total-payroll">PKR 0</div>
                            <div class="stat-label">Monthly Payroll</div>
                        </div>
                        <div class="stat-icon">
                            <i class="fas fa-coins"></i>
                        </div>
                    </div>
                </div>

                <div class="stat-card clickable-card" onclick="showMetricDetails('turnover-rate')">
                    <div class="stat-card-header">
                        <div>
                            <div class="stat-value" id="turnover-rate">0%</div>
                            <div class="stat-label">Turnover Rate</div>
                        </div>
                        <div class="stat-icon">
                            <i class="fas fa-sync-alt"></i>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Gender & Employment Metrics -->
            <div class="section-header">
                <h2 class="section-title">Workforce Analytics</h2>
            </div>

            <div class="card-grid">
                <div class="info-card clickable-card" onclick="showMetricDetails('male-employees')">
                    <div class="card-icon-container">
                        <i class="fas fa-mars"></i>
                    </div>
                    <div class="card-value" id="male-employees">0</div>
                    <div class="card-label">Male Employees</div>
                </div>

                <div class="info-card clickable-card" onclick="showMetricDetails('female-employees')">
                    <div class="card-icon-container">
                        <i class="fas fa-venus"></i>
                    </div>
                    <div class="card-value" id="female-employees">0</div>
                    <div class="card-label">Female Employees</div>
                </div>

                <div class="info-card clickable-card" onclick="showMetricDetails('gender-ratio')">
                    <div class="card-icon-container">
                        <i class="fas fa-balance-scale"></i>
                    </div>
                    <div class="card-value" id="gender-ratio">0%</div>
                    <div class="card-label">Female Ratio</div>
                </div>

                <div class="info-card clickable-card" onclick="showMetricDetails('avg-tenure')">
                    <div class="card-icon-container">
                        <i class="fas fa-calendar-alt"></i>
                    </div>
                    <div class="card-value" id="avg-tenure">0</div>
                    <div class="card-label">Avg Tenure (Years)</div>
                </div>
            </div>

            <!-- Employment Types -->
            <div class="section-header">
                <h2 class="section-title">Employment Distribution</h2>
            </div>

            <div class="card-grid">
                <div class="info-card clickable-card" onclick="showMetricDetails('regular-employees')">
                    <div class="card-icon-container">
                        <i class="fas fa-id-card"></i>
                    </div>
                    <div class="card-value" id="regular-employees">0</div>
                    <div class="card-label">Regular Employees</div>
                </div>

                <div class="info-card clickable-card" onclick="showMetricDetails('contractual-employees')">
                    <div class="card-icon-container">
                        <i class="fas fa-file-contract"></i>
                    </div>
                    <div class="card-value" id="contractual-employees">0</div>
                    <div class="card-label">Contractual</div>
                </div>

                <div class="info-card clickable-card" onclick="showMetricDetails('project-employees')">
                    <div class="card-icon-container">
                        <i class="fas fa-project-diagram"></i>
                    </div>
                    <div class="card-value" id="project-employees">0</div>
                    <div class="card-label">Project Based</div>
                </div>
            </div>

            <!-- Recent Activity -->
            <div class="section-header">
                <h2 class="section-title">Recent Activity</h2>
            </div>

            <div class="card-grid">
                <div class="info-card clickable-card" onclick="showMetricDetails('joiners-30days')">
                    <div class="card-icon-container">
                        <i class="fas fa-user-plus"></i>
                    </div>
                    <div class="card-value" id="joiners-30days">0</div>
                    <div class="card-label">Joiners (30 Days)</div>
                </div>

                <div class="info-card clickable-card" onclick="showMetricDetails('leavers-30days')">
                    <div class="card-icon-container">
                        <i class="fas fa-user-minus"></i>
                    </div>
                    <div class="card-value" id="leavers-30days">0</div>
                    <div class="card-label">Leavers (30 Days)</div>
                </div>

                <div class="info-card clickable-card" onclick="showMetricDetails('joiners-90days')">
                    <div class="card-icon-container">
                        <i class="fas fa-user-plus"></i>
                    </div>
                    <div class="card-value" id="joiners-90days">0</div>
                    <div class="card-label">Joiners (90 Days)</div>
                </div>

                <div class="info-card clickable-card" onclick="showMetricDetails('leavers-90days')">
                    <div class="card-icon-container">
                        <i class="fas fa-user-minus"></i>
                    </div>
                    <div class="card-value" id="leavers-90days">0</div>
                    <div class="card-label">Leavers (90 Days)</div>
                </div>
            </div>

            <!-- Status Analytics -->
            <div class="section-header">
                <h2 class="section-title">Current Status</h2>
            </div>

            <div class="card-grid">
                <div class="info-card clickable-card" onclick="showMetricDetails('employees-present')">
                    <div class="card-icon-container">
                        <i class="fas fa-user-check"></i>
                    </div>
                    <div class="card-value" id="employees-present">0</div>
                    <div class="card-label">Present</div>
                </div>

                <div class="info-card clickable-card" onclick="showMetricDetails('employees-wfh')">
                    <div class="card-icon-container">
                        <i class="fas fa-home"></i>
                    </div>
                    <div class="card-value" id="employees-wfh">0</div>
                    <div class="card-label">Work From Home</div>
                </div>

                <div class="info-card clickable-card" onclick="showMetricDetails('employees-annual-leave')">
                    <div class="card-icon-container">
                        <i class="fas fa-umbrella-beach"></i>
                    </div>
                    <div class="card-value" id="employees-annual-leave">0</div>
                    <div class="card-label">Annual Leave</div>
                </div>

                <div class="info-card clickable-card" onclick="showMetricDetails('employees-short-leave')">
                    <div class="card-icon-container">
                        <i class="fas fa-clock"></i>
                    </div>
                    <div class="card-value" id="employees-short-leave">0</div>
                    <div class="card-label">Short Leave</div>
                </div>

                <div class="info-card clickable-card" onclick="showMetricDetails('employees-on-leave')">
                    <div class="card-icon-container">
                        <i class="fas fa-calendar-times"></i>
                    </div>
                    <div class="card-value" id="employees-on-leave">0</div>
                    <div class="card-label">On Leave (Other)</div>
                </div>

                <div class="info-card clickable-card" onclick="showMetricDetails('employees-inactive')">
                    <div class="card-icon-container">
                        <i class="fas fa-user-slash"></i>
                    </div>
                    <div class="card-value" id="employees-inactive">0</div>
                    <div class="card-label">Inactive</div>
                </div>
            </div>

            <!-- Department Analytics Charts -->
            <div class="section-header">
                <h2 class="section-title">Department Analytics</h2>
            </div>

            <div class="chart-grid">
                <div class="chart-card">
                    <h3 class="chart-card-title">Gender Distribution by Department</h3>
                    <div id="gender-by-dept-chart"></div>
                </div>

                <div class="chart-card">
                    <h3 class="chart-card-title">Employee Type Distribution</h3>
                    <div id="employment-type-chart"></div>
                </div>

                <div class="chart-card">
                    <h3 class="chart-card-title">Top 5 Departments by Headcount</h3>
                    <div id="dept-headcount-chart"></div>
                </div>

                <div class="chart-card">
                    <h3 class="chart-card-title">Average Salary by Department</h3>
                    <div id="dept-salary-chart"></div>
                </div>
            </div>
        </section>

        <!-- Employees Page -->
        <section id="employees" class="page">
            <div class="page-header">
                <h1 class="page-title">Employee Directory</h1>
                <p class="page-subtitle">Manage your workforce</p>
            </div>

            <div class="table-card">
                <div class="filter-bar">
                    <div class="search-box">
                        <i class="fas fa-search"></i>
                        <input type="text" id="employee-search" placeholder="Search employees by name, ID, or department...">
                    </div>
                    <select class="filter-select" id="gender-filter">
                        <option value="">All Genders</option>
                        <option value="Male">Male</option>
                        <option value="Female">Female</option>
                    </select>
                    <select class="filter-select" id="department-filter">
                        <option value="">All Departments</option>
                    </select>
                    <select class="filter-select" id="status-filter">
                        <option value="">All Status</option>
                        <option value="Active">Active</option>
                        <option value="Inactive">Inactive</option>
                    </select>
                </div>

                <div class="table-responsive">
                    <table class="data-table" id="employees-table">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Name</th>
                                <th>Gender</th>
                                <th>Department</th>
                                <th>Position</th>
                                <th>Status</th>
                                <th>Date of Joining</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>
        </section>

        <!-- Payroll Page -->
        <section id="payroll" class="page">
            <div class="page-header">
                <h1 class="page-title">Payroll & Transaction Log</h1>
                <p class="page-subtitle">Salary details and transaction history</p>
            </div>

            <!-- Payroll Summary -->
            <div class="hero-stats" style="margin-bottom: var(--space-xl);">
                <div class="stat-card">
                    <div class="stat-card-header">
                        <div>
                            <div class="stat-value" id="payroll-total-base">PKR 0</div>
                            <div class="stat-label">Total Base Salary</div>
                        </div>
                        <div class="stat-icon">
                            <i class="fas fa-dollar-sign"></i>
                        </div>
                    </div>
                </div>

                <div class="stat-card">
                    <div class="stat-card-header">
                        <div>
                            <div class="stat-value" id="payroll-total-allowances">PKR 0</div>
                            <div class="stat-label">Total Allowances</div>
                        </div>
                        <div class="stat-icon">
                            <i class="fas fa-hand-holding-usd"></i>
                        </div>
                    </div>
                </div>

                <div class="stat-card">
                    <div class="stat-card-header">
                        <div>
                            <div class="stat-value" id="payroll-total-benefits">PKR 0</div>
                            <div class="stat-label">Total Benefits</div>
                        </div>
                        <div class="stat-icon">
                            <i class="fas fa-gift"></i>
                        </div>
                    </div>
                </div>

                <div class="stat-card">
                    <div class="stat-card-header">
                        <div>
                            <div class="stat-value" id="payroll-total-ctc">PKR 0</div>
                            <div class="stat-label">Total CTC</div>
                        </div>
                        <div class="stat-icon">
                            <i class="fas fa-chart-line"></i>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Payroll Table -->
            <div class="table-card">
                <h3 style="margin-bottom: var(--space-lg); font-size: 1.5rem; font-weight: 700;">Employee Salaries</h3>
                <div class="table-responsive">
                    <table class="data-table" id="payroll-table">
                        <thead>
                            <tr>
                                <th>Employee</th>
                                <th>Base Salary</th>
                                <th>Allowances</th>
                                <th>Benefits</th>
                                <th>Total CTC</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>

            <!-- Recent Hires -->
            <div class="table-card" style="margin-top: var(--space-xl);">
                <h3 style="margin-bottom: var(--space-lg); font-size: 1.5rem; font-weight: 700;">Recent Hires</h3>
                <div class="table-responsive">
                    <table class="data-table" id="recent-hires-table">
                        <thead>
                            <tr>
                                <th>Name</th>
                                <th>Department</th>
                                <th>Position</th>
                                <th>Date of Joining</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>

            <!-- Transaction Log -->
            <div class="table-card" style="margin-top: var(--space-xl);">
                <h3 style="margin-bottom: var(--space-lg); font-size: 1.5rem; font-weight: 700;">Transaction Log</h3>
                <div class="table-responsive">
                    <table class="data-table" id="transaction-table">
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Employee</th>
                                <th>Transaction Type</th>
                                <th>Details</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>
        </section>

        <!-- Departments Page -->
        <section id="departments" class="page">
            <div class="page-header">
                <h1 class="page-title">Departments</h1>
                <p class="page-subtitle">Organizational structure and team distribution</p>
            </div>

            <div id="department-grid"></div>
        </section>

        <!-- Reports Page -->
        <section id="reports" class="page">
            <div class="page-header">
                <h1 class="page-title">Reports & Analytics</h1>
                <p class="page-subtitle">Generate custom reports</p>
            </div>

            <div class="table-card">
                <form id="report-form">
                    <div class="form-grid">
                        <div class="form-group">
                            <label>Department</label>
                            <select id="report-department" class="filter-select" style="width: 100%; padding: var(--space-md);">
                                <option value="">All Departments</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>&nbsp;</label>
                            <button type="submit" class="btn primary" style="width: 100%;">
                                <i class="fas fa-file-alt"></i> Generate Report
                            </button>
                        </div>
                    </div>
                </form>

                <div style="margin-top: var(--space-xl);">
                    <button id="download-report-btn" class="btn primary" style="display: none;">
                        <i class="fas fa-download"></i> Download Report
                    </button>
                </div>

                <div id="report-output-content" style="margin-top: var(--space-lg);"></div>
            </div>
        </section>
    </main>

    <!-- Employee Modal -->
    <div id="employee-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Employee Details</h3>
                <button class="close-modal" onclick="document.getElementById('employee-modal').style.display='none'">&times;</button>
            </div>

            <form id="employee-form">
                <input type="hidden" id="employee-index">
                
                <div class="profile-pic-container">
                    <img id="profile-pic-preview" class="profile-pic-preview" alt="Profile">
                    <input type="file" id="employee-profile-pic" accept="image/*" style="display: none;">
                    <button type="button" class="btn secondary" onclick="document.getElementById('employee-profile-pic').click()">
                        <i class="fas fa-camera"></i> Upload Photo
                    </button>
                </div>

                <div class="tab-buttons">
                    <button type="button" class="tab-button active" data-tab="personal">Personal Info</button>
                    <button type="button" class="tab-button" data-tab="employment">Employment</button>
                </div>

                <div class="tab-content active" id="tab-personal">
                    <div class="form-grid">
                        <div class="form-group">
                            <label>Employee ID</label>
                            <input type="text" name="ID">
                        </div>
                        <div class="form-group">
                            <label>Full Name</label>
                            <input type="text" name="Name">
                        </div>
                        <div class="form-group">
                            <label>Father's Name</label>
                            <input type="text" name="Father Name">
                        </div>
                        <div class="form-group">
                            <label>CNIC</label>
                            <input type="text" name="CNIC">
                        </div>
                        <div class="form-group">
                            <label>Mobile</label>
                            <input type="tel" name="Mobile">
                        </div>
                        <div class="form-group">
                            <label>Email</label>
                            <input type="email" name="Email">
                        </div>
                        <div class="form-group">
                            <label>Date of Birth</label>
                            <input type="date" name="DOB" id="employee-doj">
                        </div>
                        <div class="form-group">
                            <label>Gender</label>
                            <select name="Gender">
                                <option value="Male">Male</option>
                                <option value="Female">Female</option>
                            </select>
                        </div>
                    </div>
                </div>

                <div class="tab-content" id="tab-employment">
                    <div class="form-grid">
                        <div class="form-group">
                            <label>Department</label>
                            <input type="text" name="Department">
                        </div>
                        <div class="form-group">
                            <label>Position</label>
                            <input type="text" name="Position">
                        </div>
                        <div class="form-group">
                            <label>Employment Type</label>
                            <select name="Employment Type">
                                <option value="Regular">Regular</option>
                                <option value="Contractual">Contractual</option>
                                <option value="Project">Project</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Date of Joining</label>
                            <input type="date" name="Joining Date">
                        </div>
                        <div class="form-group">
                            <label>Status</label>
                            <select name="Status">
                                <option value="Active">Active</option>
                                <option value="Inactive">Inactive</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Today's Status</label>
                            <select name="Today's Status">
                                <option value="Present">Present</option>
                                <option value="WFH">Work From Home</option>
                                <option value="Annual Leave">Annual Leave</option>
                                <option value="Short Leave">Short Leave</option>
                                <option value="On Leave">On Leave</option>
                            </select>
                        </div>
                    </div>
                </div>

                <div class="action-buttons">
                    <button type="submit" class="btn primary">
                        <i class="fas fa-save"></i> Save
                    </button>
                    <button type="button" class="btn secondary" onclick="document.getElementById('employee-modal').style.display='none'">
                        Cancel
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Payroll Modal -->
    <div id="payroll-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Payroll Details</h3>
                <button class="close-modal" onclick="document.getElementById('payroll-modal').style.display='none'">&times;</button>
            </div>

            <form id="payroll-form">
                <input type="hidden" id="payroll-employee-index">
                
                <div class="form-group">
                    <label>Employee Name</label>
                    <input type="text" id="payroll-name" readonly style="background: var(--border-light);">
                </div>

                <div class="form-grid">
                    <div class="form-group">
                        <label>Base Salary</label>
                        <input type="number" id="payroll-salary">
                    </div>
                    <div class="form-group">
                        <label>Travel Allowance</label>
                        <input type="number" id="payroll-travel">
                    </div>
                    <div class="form-group">
                        <label>Fuel/Grocery Allowance</label>
                        <input type="number" id="payroll-fuel">
                    </div>
                    <div class="form-group">
                        <label>Other Allowance</label>
                        <input type="number" id="payroll-other">
                    </div>
                    <div class="form-group">
                        <label>Provident Fund</label>
                        <input type="number" id="payroll-pf">
                    </div>
                    <div class="form-group">
                        <label>EOBI</label>
                        <input type="number" id="payroll-eobi">
                    </div>
                </div>

                <div style="background: var(--border-light); padding: var(--space-lg); border-radius: var(--radius-md); margin: var(--space-lg) 0;">
                    <h4 style="margin-bottom: var(--space-sm);">Total CTC Preview</h4>
                    <div style="font-size: 2rem; font-weight: 700; color: var(--primary-orange);" id="payroll-ctc-preview">PKR 0</div>
                </div>

                <div class="action-buttons">
                    <button type="submit" class="btn primary">
                        <i class="fas fa-save"></i> Update Payroll
                    </button>
                    <button type="button" class="btn secondary" onclick="document.getElementById('payroll-modal').style.display='none'">
                        Cancel
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Transaction Modal -->
    <div id="transaction-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Add Transaction</h3>
                <button class="close-modal" onclick="document.getElementById('transaction-modal').style.display='none'">&times;</button>
            </div>

            <form id="transaction-form">
                <div class="form-grid">
                    <div class="form-group">
                        <label>Employee</label>
                        <select id="transaction-employee-id">
                            <option value="">Select Employee</option>
                        </select>
                    </div>
                </div>

                <div id="dynamic-transaction-fields"></div>

                <div class="action-buttons">
                    <button type="submit" class="btn primary">
                        <i class="fas fa-check"></i> Submit
                    </button>
                    <button type="button" class="btn secondary" onclick="document.getElementById('transaction-modal').style.display='none'">
                        Cancel
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Details Modal -->
    <div id="details-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="metric-details-title">Details</h3>
                <button class="close-modal" onclick="document.getElementById('details-modal').style.display='none'">&times;</button>
            </div>
            <div id="metric-details-content"></div>
        </div>
    </div>

    <!-- Department Details Modal -->
    <div id="department-details-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="department-details-title">Department Details</h3>
                <button class="close-modal" onclick="document.getElementById('department-details-modal').style.display='none'">&times;</button>
            </div>
            <div id="department-details-content"></div>
        </div>
    </div>

    <!-- Employee Details Modal -->
    <div id="metric-details-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="employee-details-title">Employee Details</h3>
                <button class="close-modal" onclick="document.getElementById('metric-details-modal').style.display='none'">&times;</button>
            </div>
            <div id="employee-details-content"></div>
        </div>
    </div>
    <script>
        // ===================================================
        // PASSWORD PROTECTION
        // ===================================================
        // CHANGE YOUR PASSWORD HERE:
        /* ========================================
           PASSWORD SECURITY
           ========================================
           Current password: rads2025
           
           The password is stored as a SHA-256 hash for security.
           Anyone viewing the source code cannot see the actual password.
           
           TO CHANGE THE PASSWORD:
           1. Open your browser's console (F12)
           2. Run this command with your new password:
              
              hashPassword('YourNewPassword').then(hash => console.log(hash))
           
           3. Copy the hash that appears in the console
           4. Replace the PASSWORD_HASH value below with your new hash
           5. Update the comment to note your new password for your records
           ======================================== */
        
        const PASSWORD_HASH = '406a6f694d97da5dd6dff987168113510914dc80bcc6c3ae6b2eb29fdfddb496';
        
        // Function to hash password using SHA-256
        async function hashPassword(password) {
            const encoder = new TextEncoder();
            const data = encoder.encode(password);
            const hashBuffer = await crypto.subtle.digest('SHA-256', data);
            const hashArray = Array.from(new Uint8Array(hashBuffer));
            const hashHex = hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
            return hashHex;
        }
        
        // Authentication functions
        function checkAuthentication() {
            const isAuthenticated = sessionStorage.getItem('hrDashboardAuth') === 'true';
            const loginOverlay = document.getElementById('loginOverlay');
            
            if (isAuthenticated) {
                loginOverlay.classList.add('hidden');
            } else {
                loginOverlay.classList.remove('hidden');
            }
            
            return isAuthenticated;
        }

        function logout() {
            sessionStorage.removeItem('hrDashboardAuth');
            location.reload();
        }

        // Login form handler
        document.addEventListener('DOMContentLoaded', function() {
            const loginForm = document.getElementById('loginForm');
            const passwordInput = document.getElementById('passwordInput');
            const loginError = document.getElementById('loginError');
            
            // Check authentication on page load
            checkAuthentication();
            
            loginForm.addEventListener('submit', async function(e) {
                e.preventDefault();
                
                const enteredPassword = passwordInput.value;
                const enteredHash = await hashPassword(enteredPassword);
                
                if (enteredHash === PASSWORD_HASH) {
                    // Correct password
                    sessionStorage.setItem('hrDashboardAuth', 'true');
                    document.getElementById('loginOverlay').classList.add('hidden');
                    loginError.classList.remove('show');
                    passwordInput.value = '';
                    
                    // Load data after successful login
                    setTimeout(() => {
                        loadDataFromGoogleSheets();
                    }, 100);
                } else {
                    // Wrong password
                    loginError.classList.add('show');
                    passwordInput.value = '';
                    passwordInput.focus();
                    
                    // Shake animation
                    const loginBox = document.querySelector('.login-box');
                    loginBox.style.animation = 'shake 0.5s';
                    setTimeout(() => {
                        loginBox.style.animation = '';
                    }, 500);
                }
            });
        });

        // Add shake animation
        const style = document.createElement('style');
        style.textContent = `
            @keyframes shake {
                0%, 100% { transform: translateX(0); }
                10%, 30%, 50%, 70%, 90% { transform: translateX(-10px); }
                20%, 40%, 60%, 80% { transform: translateX(10px); }
            }
        `;
        document.head.appendChild(style);

        // ===================================================
        // DASHBOARD CODE
        // ===================================================

        // Google Sheets CSV Configuration
        const GOOGLE_SHEETS_CSV_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vRTf2qj4n3jmOGT1vkd1QUChdZbazTynus5-AgNUTrGPfGjbmLoWWKk_YneSHnNWjMphgDmcmt_m5Ac/pub?output=csv';
        const AUTO_REFRESH_INTERVAL = 300000; // 5 minutes

        let employees = [];
        let mockTransactionLog = [];
        let mockReportData = [];

        // --- DOM Elements ---
        const themeToggleBtn = document.getElementById('theme-toggle');
        const body = document.body;
        const navLinks = document.querySelectorAll('.nav-link[data-page]');
        const pages = document.querySelectorAll('.page');
        const pageTitle = document.getElementById('page-title');
        
        const employeeModal = document.getElementById('employee-modal');
        const employeeForm = document.getElementById('employee-form');
        const employeeProfilePicInput = document.getElementById('employee-profile-pic');
        const profilePicPreview = document.getElementById('profile-pic-preview');
        
        const payrollModal = document.getElementById('payroll-modal');
        const payrollForm = document.getElementById('payroll-form');
        
        const employeesTableBody = document.getElementById('employees-table').querySelector('tbody');
        const recentHiresTableBody = document.getElementById('recent-hires-table').querySelector('tbody');
        const payrollTableBody = document.getElementById('payroll-table').querySelector('tbody');
        const transactionTableBody = document.getElementById('transaction-table').querySelector('tbody');
        
        const detailsModal = document.getElementById('details-modal');
        const departmentGrid = document.getElementById('department-grid');
        const departmentDetailsModal = document.getElementById('department-details-modal');
        const departmentDetailsTitle = document.getElementById('department-details-title');
        const departmentDetailsContent = document.getElementById('department-details-content');
        
        const employeeSearch = document.getElementById('employee-search');
        const genderFilter = document.getElementById('gender-filter');
        const departmentFilter = document.getElementById('department-filter');
        const statusFilter = document.getElementById('status-filter');
        
        const reportDepartmentSelect = document.getElementById('report-department');
        const reportForm = document.getElementById('report-form');
        const downloadReportBtn = document.getElementById('download-report-btn');
        const reportOutputContent = document.getElementById('report-output-content');
        
        const transactionModal = document.getElementById('transaction-modal');
        const transactionForm = document.getElementById('transaction-form');
        const dynamicTransactionFields = document.getElementById('dynamic-transaction-fields');
        const transactionEmployeeSelect = document.getElementById('transaction-employee-id');
        
        // --- Theme Management ---
        (function setupTheme() {
            const savedTheme = localStorage.getItem('theme');
            if (savedTheme === 'dark') {
                body.classList.add('dark-theme');
                themeToggleBtn.innerHTML = '<i class="fas fa-sun"></i>';
            } else {
                body.classList.remove('dark-theme');
                themeToggleBtn.innerHTML = '<i class="fas fa-moon"></i>';
            }
        })();

        // --- CSV Data Functions ---
        function parseCSVLine(line) {
            const result = [];
            let current = '';
            let inQuotes = false;
            
            for (let char of line) {
                if (char === '"') {
                    inQuotes = !inQuotes;
                } else if (char === ',' && !inQuotes) {
                    result.push(current.trim());
                    current = '';
                } else {
                    current += char;
                }
            }
            result.push(current.trim());
            return result;
        }

        function parseCSVData(csvText) {
            const lines = csvText.split('\n').filter(line => line.trim());
            if (lines.length === 0) return [];
            
            const headers = parseCSVLine(lines[0]);
            const data = [];
            
            for (let i = 1; i < lines.length; i++) {
                const values = parseCSVLine(lines[i]);
                if (values.length === headers.length) {
                    const row = {};
                    headers.forEach((header, index) => {
                        row[header] = values[index];
                    });
                    data.push(row);
                }
            }
            return data;
        }

        async function loadDataFromGoogleSheets() {
            const btn = document.getElementById('refresh-data-btn');
            if (btn) {
                btn.classList.add('loading');
            }
            
            try {
                const timestamp = new Date().getTime();
                const url = `${GOOGLE_SHEETS_CSV_URL}&t=${timestamp}`;
                
                console.log('Fetching from Google Sheets...');
                console.log('URL:', url);
                
                const response = await fetch(url, {
                    method: 'GET',
                    mode: 'cors',
                    cache: 'no-cache',
                    headers: {
                        'Cache-Control': 'no-cache'
                    }
                });
                
                console.log('Response status:', response.status);
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }
                
                const csvText = await response.text();
                console.log('CSV loaded, length:', csvText.length);
                const rawData = parseCSVData(csvText);
                
                if (rawData.length > 0) {
                    // Process employee data with column mapping and calculations
                    employees = rawData.map(emp => {
                        // First map column names to standard format
                        const mappedEmp = mapColumnNames(emp);
                        
                        // Then calculate salary fields
                        const baseSalary = parseFloat(mappedEmp['Base Salary'] || 0);
                        const travelAllowance = parseFloat(mappedEmp['Travel Allowance'] || 0);
                        const fuelAllowance = parseFloat(mappedEmp['Fuel/Grocery Allowance'] || 0);
                        const otherAllowance = parseFloat(mappedEmp['Other Allowance'] || 0);
                        const providentFund = parseFloat(mappedEmp['Provident Fund'] || 0);
                        const eobi = parseFloat(mappedEmp['EOBI'] || 0);
                        
                        // Salary = Base Salary + All Allowances (what employee takes home)
                        const salary = baseSalary + travelAllowance + fuelAllowance + otherAllowance;
                        
                        // Total Cost to Company = Salary + PF + EOBI (what organization pays)
                        const totalCost = baseSalary + travelAllowance + fuelAllowance + otherAllowance + providentFund + eobi;
                        
                        return {
                            ...mappedEmp,
                            'Salary': salary.toFixed(2),
                            'Total Cost to Company': totalCost.toFixed(2)
                        };
                    });
                    
                    console.log(`‚úì Loaded ${employees.length} employees from Google Sheets at ${new Date().toLocaleTimeString()}`);
                    updateUI();
                    
                    if (btn) {
                        btn.classList.remove('loading');
                    }
                    return true;
                }
            } catch (error) {
                console.error('Error loading from Google Sheets:', error);
                if (btn) {
                    btn.classList.remove('loading');
                }
                if (employees.length === 0) {
                    alert('Could not load data from Google Sheets. Please check:\n1. Your sheet is published\n2. Internet connection is working\n\nError: ' + error.message);
                }
                return false;
            }
        }

        // Auto-refresh every 5 minutes
        setInterval(loadDataFromGoogleSheets, AUTO_REFRESH_INTERVAL);

        // Column name mapping function
        function mapColumnNames(emp) {
            const mapped = {};
            
            // Map ID variations
            mapped['ID'] = emp['ID'] || emp['Employee ID'] || emp['EmployeeID'] || emp['Emp ID'] || '';
            
            // Map Name variations
            mapped['Name'] = emp['Name'] || emp['Full Name'] || emp['FullName'] || emp['Employee Name'] || '';
            
            // Map Position/Designation
            mapped['Position'] = emp['Position'] || emp['Designation'] || emp['Job Title'] || '';
            
            // Map Department
            mapped['Department'] = emp['Department'] || emp['Dept'] || '';
            
            // Map Status
            mapped['Status'] = emp['Status'] || 'Active';
            
            // Map Date fields
            mapped['Date of Joining'] = emp['Date of Joining'] || emp['Joining Date'] || emp['Join Date'] || '';
            mapped['Date of Leaving'] = emp['Date of Leaving'] || emp['Date of Separation'] || emp['Leaving Date'] || '';
            mapped['Termination Reason'] = emp['Termination Reason'] || emp['Reason of Separation'] || emp['Leaving Reason'] || '';
            
            // Map Salary fields
            mapped['Base Salary'] = emp['Base Salary'] || emp['Monthly Salary'] || emp['Basic Salary'] || emp['Salary'] || '0';
            mapped['Travel Allowance'] = emp['Travel Allowance'] || emp['Travel'] || '0';
            mapped['Fuel/Grocery Allowance'] = emp['Fuel/Grocery Allowance'] || emp['Fuel Allowance'] || '0';
            mapped['Other Allowance'] = emp['Other Allowance'] || emp['Other'] || '0';
            mapped['Provident Fund'] = emp['Provident Fund'] || emp['PF'] || '0';
            mapped['EOBI'] = emp['EOBI'] || '0';
            
            // Map other fields
            mapped['Gender'] = emp['Gender'] || emp['Sex'] || '';
            mapped['Contact Number'] = emp['Contact Number'] || emp['Phone'] || emp['Mobile'] || '';
            mapped['Email'] = emp['Email'] || emp['Email Address'] || '';
            mapped['Address'] = emp['Address'] || '';
            mapped['Supervisor'] = emp['Supervisor'] || emp['Manager'] || emp['Reporting To'] || '';
            mapped['Employment Type'] = emp['Employment Type'] || emp['Joined As'] || 'Regular';
            mapped['Position Type'] = emp['Position Type'] || '';
            mapped['Stationed At'] = emp['Stationed At'] || emp['Location'] || '';
            mapped['Field Office City'] = emp['Field Office City'] || '';
            mapped['Cost Center'] = emp['Cost Center'] || emp['Project'] || '';
            mapped['Skills'] = emp['Skills'] || '';
            mapped['Emergency Name'] = emp['Emergency Name'] || emp['Emergency Contact'] || '';
            mapped['Emergency Relationship'] = emp['Emergency Relationship'] || '';
            mapped['Emergency Phone'] = emp['Emergency Phone'] || '';
            mapped['ProfilePic'] = emp['ProfilePic'] || '';
            
            return mapped;
        }

        // --- Page Navigation ---
        function showPage(pageId) {
            pages.forEach(page => page.classList.remove('active'));
            document.getElementById(pageId).classList.add('active');
            pageTitle.textContent = pageId.charAt(0).toUpperCase() + pageId.slice(1);
            document.querySelectorAll('.nav-link').forEach(link => link.classList.remove('active'));
            document.querySelector(`.nav-link[data-page="${pageId}"]`).classList.add('active');
            updateUI();
        }

        // --- Modal Control ---
        function openEmployeeModal(employee = null) {
            employeeForm.reset();
            profilePicPreview.style.display = 'none';
            profilePicPreview.src = '';
            document.getElementById('employee-index').value = '';
            document.querySelector('#employee-modal h3').textContent = 'Add New Employee';
            if (!employee) {
                document.getElementById('employee-doj').value = new Date().toISOString().split('T')[0];
            }
            document.querySelectorAll('.tab-content, .tab-button').forEach(el => el.classList.remove('active'));
            document.getElementById('tab-personal').classList.add('active');
            document.querySelector('.tab-button[data-tab="personal"]').classList.add('active');
            if (employee) {
                fillEmployeeForm(employee);
            }
            employeeModal.style.display = 'flex';
        }

        function openDetailsModal(employee) {
            if (!employee) return;
            const detailsContent = document.getElementById('employee-details-content');
            const formatCurrency = (value) => `PKR ${parseFloat(value || 0).toLocaleString()}`;
            const N_A = '<span style="color: var(--secondary-color);">N/A</span>';

            detailsContent.innerHTML = `
                <div style="display: flex; align-items: center; gap: 20px; margin-bottom: 20px;">
                    <img src="${employee.ProfilePic || `https://placehold.co/100x100/${body.classList.contains('dark-theme') ? 'CF9999/2D2D2D' : 'A05252/FFFFFF'}?text=${employee.Name ? employee.Name.charAt(0) : 'E'}`}" alt="Profile" style="width: 100px; height: 100px; border-radius: 50%; object-fit: cover; border: 2px solid var(--border-color);">
                    <div>
                        <h2 style="margin-bottom: 5px;">${employee.Name || N_A}</h2>
                        <p style="color: var(--secondary-color); margin-bottom: 8px;">${employee.Position || 'Position not set'} ‚Ä¢ ${employee.Department || 'No Department'}</p>
                        <span class="status-badge status-${(employee.Status || '').toLowerCase().replace('-', '')}">${employee.Status || N_A}</span>
                    </div>
                </div>
                
                <h3 style="font-size: 1.2rem; border-bottom: 1px solid var(--border-color); padding-bottom: 5px; margin-bottom: 10px;">Personal & Contact</h3>
                <div class="details-grid">
                    <div class="details-item"><h4>Employee ID</h4><p>${employee.ID || N_A}</p></div>
                    <div class="details-item"><h4>Gender</h4><p>${employee.Gender || N_A}</p></div>
                    <div class="details-item"><h4>Contact Number</h4><p>${employee['Contact Number'] || N_A}</p></div>
                    <div class="details-item" style="grid-column: 1 / -1;"><h4>Address</h4><p>${employee.Address || N_A}</p></div>
                </div>

                <h3 style="font-size: 1.2rem; border-bottom: 1px solid var(--border-color); padding-bottom: 5px; margin-bottom: 10px;">Emergency Contact</h3>
                <div class="details-grid">
                    <div class="details-item"><h4>Name</h4><p>${employee['Emergency Name'] || N_A}</p></div>
                    <div class="details-item"><h4>Relationship</h4><p>${employee['Emergency Relationship'] || N_A}</p></div>
                    <div class="details-item"><h4>Phone</h4><p>${employee['Emergency Phone'] || N_A}</p></div>
                </div>

                <h3 style="font-size: 1.2rem; border-bottom: 1px solid var(--border-color); padding-bottom: 5px; margin-bottom: 10px;">Employment Details</h3>
                <div class="details-grid">
                    <div class="details-item"><h4>Date of Joining</h4><p>${employee['Date of Joining'] || N_A}</p></div>
                    <div class="details-item"><h4>Supervisor</h4><p>${employee.Supervisor || N_A}</p></div>
                    <div class="details-item"><h4>Employment Type</h4><p>${employee['Employment Type'] || N_A}</p></div>
                    <div class="details-item"><h4>Stationed At</h4><p>${employee['Stationed At'] || N_A}</p></div>
                </div>

                <h3 style="font-size: 1.2rem; border-bottom: 1px solid var(--border-color); padding-bottom: 5px; margin-bottom: 10px;">Compensation</h3>
                <div class="details-grid">
                    <div class="details-item"><h4>Base Salary</h4><p>${formatCurrency(employee['Base Salary'])}</p></div>
                    <div class="details-item"><h4>Allowances</h4><p>${formatCurrency((parseFloat(employee['Travel Allowance'] || 0) + parseFloat(employee['Fuel/Grocery Allowance'] || 0) + parseFloat(employee['Other Allowance'] || 0)))}</p></div>
                    <div class="details-item"><h4>Deductions (PF+EOBI)</h4><p>${formatCurrency(parseFloat(employee['Provident Fund'] || 0) + parseFloat(employee['EOBI'] || 0))}</p></div>
                    <div class="details-item"><h4>Total Cost</h4><p><strong>${formatCurrency(employee['Total Cost to Company'])}</strong></p></div>
                </div>
                
                ${employee.Status === 'Inactive' ? `
                <h3 style="font-size: 1.2rem; color: var(--primary-color); border-bottom: 1px solid var(--border-color); padding-bottom: 5px; margin-bottom: 10px;">Termination Details</h3>
                <div class="details-grid">
                    <div class="details-item"><h4>Date of Leaving</h4><p>${employee['Date of Leaving'] || N_A}</p></div>
                    <div class="details-item" style="grid-column: span 2;"><h4>Reason</h4><p>${employee['Termination Reason'] || N_A}</p></div>
                </div>` : ''}
            `;
            detailsModal.style.display = 'flex';
        }
        
        function openDepartmentDetailsModal(deptData) {
            let dept = deptData;
            if (typeof dept === 'string') {
                try { dept = JSON.parse(dept.replace(/'/g, '"')); } catch (e) { console.error("Could not parse department data:", e); return; }
            }
            if (!dept) return;

            departmentDetailsTitle.textContent = `${dept.name} Department`;
            const employeeTable = `
                <h4>Active Employees in this Department</h4>
                <div class="table-responsive">
                    <table class="data-table">
                        <thead><tr><th>Name</th><th>Position</th><th>Status</th></tr></thead>
                        <tbody>
                            ${dept.employees.map(emp => `
                                <tr>
                                    <td><a href="#" onclick="closeDepartmentDetailsModal(); openDetailsModal(employees.find(e => e.ID === '${emp.ID}'))">${emp.Name}</a></td>
                                    <td>${emp.Position}</td>
                                    <td><span class="status-badge status-${(emp.Status || '').toLowerCase().replace('-', '')}">${emp.Status}</span></td>
                                </tr>`).join('')}
                        </tbody>
                    </table>
                </div>`;
            const femalePercent = dept.employeeCount > 0 ? ((dept.femaleCount / dept.employeeCount) * 100).toFixed(1) : 0;
            const malePercent = dept.employeeCount > 0 ? ((dept.maleCount / dept.employeeCount) * 100).toFixed(1) : 0;
            
            departmentDetailsContent.innerHTML = `
                <div class="card-grid" style="margin-bottom: 20px; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));">
                     <div class="card"><div class="metric-content"><div class="value">${dept.employeeCount}</div><p>Active Employees</p></div></div>
                     <div class="card"><div class="metric-content"><div class="value">${dept.maleCount}</div><p>Male (${malePercent}%)</p></div><div class="metric-icon-container"><i class="fas fa-mars"></i></div></div>
                     <div class="card"><div class="metric-content"><div class="value">${dept.femaleCount}</div><p>Female (${femalePercent}%)</p></div><div class="metric-icon-container"><i class="fas fa-venus"></i></div></div>
                     <div class="card"><div class="metric-content"><div class="value">PKR ${dept.totalCTC.toLocaleString(undefined, {maximumFractionDigits: 0})}</div><p>Total Department Cost</p></div><div class="metric-icon-container"><i class="fas fa-coins"></i></div></div>
                </div>
                <div class="card" style="margin-bottom: 20px; padding: 16px;">
                    <h4 style="margin-bottom: 12px;">Gender Distribution</h4>
                    <div style="display: flex; gap: 2px; height: 32px; border-radius: 6px; overflow: hidden; margin-bottom: 8px;">
                        <div style="background: #6B9BD1; width: ${malePercent}%; display: flex; align-items: center; justify-content: center; color: white; font-weight: 600; font-size: 0.9rem;">${dept.maleCount > 0 ? dept.maleCount + ' Male' : ''}</div>
                        <div style="background: #CF9999; width: ${femalePercent}%; display: flex; align-items: center; justify-content: center; color: white; font-weight: 600; font-size: 0.9rem;">${dept.femaleCount > 0 ? dept.femaleCount + ' Female' : ''}</div>
                    </div>
                    <div style="display: flex; gap: 16px; font-size: 0.85rem;">
                        <div><span style="display: inline-block; width: 12px; height: 12px; background: #6B9BD1; border-radius: 2px; margin-right: 6px;"></span>Male: ${malePercent}%</div>
                        <div><span style="display: inline-block; width: 12px; height: 12px; background: #CF9999; border-radius: 2px; margin-right: 6px;"></span>Female: ${femalePercent}%</div>
                    </div>
                </div>
                ${employeeTable}`;
            departmentDetailsModal.style.display = 'flex';
        }

        function closeEmployeeModal() { employeeModal.style.display = 'none'; }
        function closePayrollModal() { payrollModal.style.display = 'none'; }
        function closeDetailsModal() { detailsModal.style.display = 'none'; }
        function closeDepartmentDetailsModal() { departmentDetailsModal.style.display = 'none'; }
        function openTransactionModal() { transactionModal.style.display = 'flex'; }
        function closeTransactionModal() { transactionModal.style.display = 'none'; }
        
        // Metric Details Modal Functions
        const metricDetailsModal = document.getElementById('metric-details-modal');
        const metricDetailsTitle = document.getElementById('metric-details-title');
        const metricDetailsContent = document.getElementById('metric-details-content');
        
        function closeMetricDetailsModal() { metricDetailsModal.style.display = 'none'; }
        
        function showMetricDetails(metricId) {
            let title = '';
            let content = '';
            const activeEmps = employees.filter(e => e.Status === 'Active');
            
            switch(metricId) {
                case 'total-employees':
                    title = 'Total Employees Breakdown';
                    const byDept = {};
                    employees.forEach(emp => {
                        const dept = emp.Department || 'Unassigned';
                        if (!byDept[dept]) byDept[dept] = { active: 0, inactive: 0 };
                        if (emp.Status === 'Active') byDept[dept].active++;
                        else byDept[dept].inactive++;
                    });
                    content = `<div class="table-responsive"><table class="data-table"><thead><tr><th>Department</th><th>Active</th><th>Inactive</th><th>Total</th></tr></thead><tbody>` +
                        Object.entries(byDept).map(([dept, counts]) => 
                            `<tr><td>${dept}</td><td>${counts.active}</td><td>${counts.inactive}</td><td>${counts.active + counts.inactive}</td></tr>`
                        ).join('') + `</tbody></table></div>`;
                    break;
                    
                case 'active-employees':
                    title = 'Active Employees by Department';
                    const deptCounts = {};
                    activeEmps.forEach(emp => {
                        const dept = emp.Department || 'Unassigned';
                        deptCounts[dept] = (deptCounts[dept] || 0) + 1;
                    });
                    content = `<div class="table-responsive"><table class="data-table"><thead><tr><th>Department</th><th>Count</th></tr></thead><tbody>` +
                        Object.entries(deptCounts).sort((a,b) => b[1] - a[1]).map(([dept, count]) => 
                            `<tr><td>${dept}</td><td>${count}</td></tr>`
                        ).join('') + `</tbody></table></div>`;
                    break;
                    
                case 'male-employees':
                case 'female-employees':
                    const gender = metricId === 'male-employees' ? 'Male' : 'Female';
                    title = `${gender} Employees by Department`;
                    const genderDepts = {};
                    activeEmps.filter(e => e.Gender === gender).forEach(emp => {
                        const dept = emp.Department || 'Unassigned';
                        genderDepts[dept] = (genderDepts[dept] || 0) + 1;
                    });
                    content = `<div class="table-responsive"><table class="data-table"><thead><tr><th>Department</th><th>Count</th></tr></thead><tbody>` +
                        Object.entries(genderDepts).sort((a,b) => b[1] - a[1]).map(([dept, count]) => 
                            `<tr><td>${dept}</td><td>${count}</td></tr>`
                        ).join('') + `</tbody></table></div>`;
                    break;
                    
                case 'gender-ratio':
                    title = 'Gender Distribution by Department';
                    const genderByDept = {};
                    activeEmps.forEach(emp => {
                        const dept = emp.Department || 'Unassigned';
                        if (!genderByDept[dept]) genderByDept[dept] = { Male: 0, Female: 0 };
                        genderByDept[dept][emp.Gender] = (genderByDept[dept][emp.Gender] || 0) + 1;
                    });
                    content = `<div class="table-responsive"><table class="data-table"><thead><tr><th>Department</th><th>Male</th><th>Female</th><th>Female %</th></tr></thead><tbody>` +
                        Object.entries(genderByDept).map(([dept, counts]) => {
                            const total = counts.Male + counts.Female;
                            const femalePercent = total > 0 ? ((counts.Female / total) * 100).toFixed(1) : '0.0';
                            return `<tr><td>${dept}</td><td>${counts.Male}</td><td>${counts.Female}</td><td>${femalePercent}%</td></tr>`;
                        }).join('') + `</tbody></table></div>`;
                    break;
                    
                case 'total-payroll':
                    title = 'Payroll by Department';
                    const payrollByDept = {};
                    activeEmps.forEach(emp => {
                        const dept = emp.Department || 'Unassigned';
                        payrollByDept[dept] = (payrollByDept[dept] || 0) + parseFloat(emp['Total Cost to Company'] || 0);
                    });
                    const totalPayroll = Object.values(payrollByDept).reduce((sum, val) => sum + val, 0);
                    content = `<div class="table-responsive"><table class="data-table"><thead><tr><th>Department</th><th>Total Cost</th><th>% of Total</th></tr></thead><tbody>` +
                        Object.entries(payrollByDept).sort((a,b) => b[1] - a[1]).map(([dept, cost]) => 
                            `<tr><td>${dept}</td><td>PKR ${cost.toLocaleString(undefined, {maximumFractionDigits: 0})}</td><td>${((cost/totalPayroll)*100).toFixed(1)}%</td></tr>`
                        ).join('') + `</tbody></table></div>`;
                    break;
                    
                case 'employees-wfh':
                    title = 'Work From Home Employees';
                    const wfhEmps = activeEmps.filter(e => e.Status === 'WFH');
                    content = wfhEmps.length > 0 ? `<div class="table-responsive"><table class="data-table"><thead><tr><th>Name</th><th>Department</th><th>Position</th></tr></thead><tbody>` +
                        wfhEmps.map(emp => `<tr><td>${emp.Name}</td><td>${emp.Department}</td><td>${emp.Position}</td></tr>`).join('') + 
                        `</tbody></table></div>` : '<p>No employees working from home.</p>';
                    break;
                    
                case 'employees-annual-leave':
                case 'employees-short-leave':
                case 'employees-on-leave':
                    const statusMap = {
                        'employees-annual-leave': 'Annual Leave',
                        'employees-short-leave': 'Short Leave',
                        'employees-on-leave': 'On Leave (Other)'
                    };
                    const statusTitle = statusMap[metricId];
                    title = `${statusTitle} Employees`;
                    
                    let leaveEmps;
                    if (metricId === 'employees-on-leave') {
                        // Check both 'On-Leave' and 'On Leave' variants
                        leaveEmps = employees.filter(e => e.Status === 'On-Leave' || e.Status === 'On Leave');
                    } else {
                        leaveEmps = employees.filter(e => e.Status === statusMap[metricId]);
                    }
                    
                    content = leaveEmps.length > 0 ? `<div class="table-responsive"><table class="data-table"><thead><tr><th>Name</th><th>Department</th><th>Position</th></tr></thead><tbody>` +
                        leaveEmps.map(emp => `<tr><td>${emp.Name}</td><td>${emp.Department}</td><td>${emp.Position}</td></tr>`).join('') + 
                        `</tbody></table></div>` : `<p>No employees on ${statusTitle.toLowerCase()}.</p>`;
                    break;
                    
                case 'employees-inactive':
                    title = 'Inactive Employees';
                    const inactiveEmps = employees.filter(e => e.Status === 'Inactive');
                    content = inactiveEmps.length > 0 ? `<div class="table-responsive"><table class="data-table"><thead><tr><th>Name</th><th>Department</th><th>Position</th><th>Date of Leaving</th><th>Reason</th></tr></thead><tbody>` +
                        inactiveEmps.map(emp => `<tr><td>${emp.Name}</td><td>${emp.Department}</td><td>${emp.Position}</td><td>${emp['Date of Leaving'] || 'N/A'}</td><td>${emp['Termination Reason'] || 'N/A'}</td></tr>`).join('') + 
                        `</tbody></table></div>` : '<p>No inactive employees.</p>';
                    break;
                    
                case 'joiners-30days':
                case 'joiners-90days':
                    const days = metricId === 'joiners-30days' ? 31 : 90;
                    title = `Joiners in Last ${days} Days`;
                    const cutoffDate = new Date(new Date().setDate(new Date().getDate() - days));
                    const joiners = employees.filter(e => {
                        const doj = parseDate(e['Date of Joining']);
                        return doj && doj >= cutoffDate;
                    }).sort((a,b) => new Date(b['Date of Joining']) - new Date(a['Date of Joining']));
                    content = joiners.length > 0 ? `<div class="table-responsive"><table class="data-table"><thead><tr><th>Name</th><th>Department</th><th>Position</th><th>Date of Joining</th></tr></thead><tbody>` +
                        joiners.map(emp => `<tr><td>${emp.Name}</td><td>${emp.Department}</td><td>${emp.Position}</td><td>${emp['Date of Joining']}</td></tr>`).join('') + 
                        `</tbody></table></div>` : '<p>No joiners in this period.</p>';
                    break;
                    
                case 'leavers-30days':
                case 'leavers-90days':
                    const leaveDays = metricId === 'leavers-30days' ? 31 : 90;
                    title = `Leavers in Last ${leaveDays} Days`;
                    const leaveCutoff = new Date(new Date().setDate(new Date().getDate() - leaveDays));
                    const leavers = employees.filter(e => {
                        const dol = parseDate(e['Date of Leaving']);
                        return dol && dol >= leaveCutoff;
                    }).sort((a,b) => new Date(b['Date of Leaving']) - new Date(a['Date of Leaving']));
                    content = leavers.length > 0 ? `<div class="table-responsive"><table class="data-table"><thead><tr><th>Name</th><th>Department</th><th>Position</th><th>Date of Leaving</th><th>Reason</th></tr></thead><tbody>` +
                        leavers.map(emp => `<tr><td>${emp.Name}</td><td>${emp.Department}</td><td>${emp.Position}</td><td>${emp['Date of Leaving']}</td><td>${emp['Termination Reason'] || 'N/A'}</td></tr>`).join('') + 
                        `</tbody></table></div>` : '<p>No leavers in this period.</p>';
                    break;
                    
                case 'employment-types':
                    title = 'Employment Type Analysis';
                    const empTypes = {};
                    employees.forEach(emp => {
                        const type = emp['Employment Type'] || emp['Position Type'] || 'Unspecified';
                        if (!empTypes[type]) empTypes[type] = { count: 0, departments: {} };
                        empTypes[type].count++;
                        const dept = emp.Department || 'Unassigned';
                        empTypes[type].departments[dept] = (empTypes[type].departments[dept] || 0) + 1;
                    });
                    
                    const totalEmps = employees.length;
                    content = `<div class="table-responsive"><table class="data-table"><thead><tr><th>Employment Type</th><th>Count</th><th>Percentage</th><th>Top Department</th></tr></thead><tbody>` +
                        Object.entries(empTypes).sort((a,b) => b[1].count - a[1].count).map(([type, data]) => {
                            const percent = ((data.count / totalEmps) * 100).toFixed(1);
                            const topDept = Object.entries(data.departments).sort((a,b) => b[1] - a[1])[0];
                            return `<tr><td><strong>${type}</strong></td><td>${data.count}</td><td>${percent}%</td><td>${topDept ? topDept[0] + ' (' + topDept[1] + ')' : 'N/A'}</td></tr>`;
                        }).join('') + `</tbody></table></div>`;
                    break;
                    
                default:
                    title = 'Details';
                    content = '<p>No detailed information available for this metric.</p>';
            }
            
            metricDetailsTitle.textContent = title;
            metricDetailsContent.innerHTML = content;
            metricDetailsModal.style.display = 'flex';
        }
        // --- Core Data & UI Rendering Functions ---
        const updateUI = () => {
            renderDashboard();
            renderEmployees();
            renderPayroll();
            renderDepartments();
            renderTransactions();
            populateReportDepartments();
            populateFilters();
            populateTransactionEmployees();
        };

        const renderDashboard = () => {
            const today = new Date();
            const thirtyOneDaysAgo = new Date(new Date().setDate(today.getDate() - 31));
            const ninetyDaysAgo = new Date(new Date().setDate(today.getDate() - 90));
            
            // Count employees by status
            const employeesPresent = employees.filter(e => e.Status === 'Active').length;
            const employeesWFH = employees.filter(e => e.Status === 'WFH' || e.Status === 'Work From Home').length;
            const employeesAnnualLeave = employees.filter(e => e.Status === 'Annual Leave').length;
            const employeesShortLeave = employees.filter(e => e.Status === 'Short Leave').length;
            const employeesOnLeave = employees.filter(e => e.Status === 'On-Leave' || e.Status === 'On Leave').length;
            const employeesInactive = employees.filter(e => e.Status === 'Inactive').length;
            
            // Active employees = All employees EXCEPT Inactive
            const activeEmployees = employees.filter(e => e.Status !== 'Inactive');
            
            // Basic metrics
            document.getElementById('total-employees').textContent = employees.length;
            document.getElementById('active-employees').textContent = activeEmployees.length;
            const maleCount = activeEmployees.filter(e => e.Gender === 'Male').length;
            const femaleCount = activeEmployees.filter(e => e.Gender === 'Female').length;
            document.getElementById('male-employees').textContent = maleCount;
            document.getElementById('female-employees').textContent = femaleCount;
            
            // Status analytics
            document.getElementById('employees-present').textContent = employeesPresent;
            document.getElementById('employees-wfh').textContent = employeesWFH;
            document.getElementById('employees-annual-leave').textContent = employeesAnnualLeave;
            document.getElementById('employees-short-leave').textContent = employeesShortLeave;
            document.getElementById('employees-on-leave').textContent = employeesOnLeave;
            document.getElementById('employees-inactive').textContent = employeesInactive;
            
            // Gender ratio
            const femaleRatio = activeEmployees.length > 0 ? ((femaleCount / activeEmployees.length) * 100).toFixed(1) : 0;
            document.getElementById('gender-ratio').textContent = femaleRatio + '%';
            
            // Average tenure calculation
            const tenures = activeEmployees.map(e => {
                const joinDate = parseDate(e['Date of Joining']);
                if (!joinDate) return 0;
                return (today - joinDate) / (1000 * 60 * 60 * 24 * 365.25);
            }).filter(t => t > 0);
            const avgTenure = tenures.length > 0 ? (tenures.reduce((a, b) => a + b, 0) / tenures.length).toFixed(1) : 0;
            document.getElementById('avg-tenure').textContent = avgTenure;
            
            // Financial metrics
            const totalPayroll = activeEmployees.reduce((sum, e) => sum + parseFloat(e['Salary'] || 0), 0);
            const totalCTC = activeEmployees.reduce((sum, e) => sum + parseFloat(e['Total Cost to Company'] || 0), 0);
            // Show Total Cost to Company (includes: Base Salary + Travel + Fuel/Grocery + Other Allowance + Provident Fund + EOBI)
            document.getElementById('total-payroll').textContent = 'PKR ' + totalCTC.toLocaleString(undefined, {maximumFractionDigits: 0});
            
            // Employment type
            const regularCount = employees.filter(e => e['Employment Type'] === 'Regular').length;
            const contractualCount = employees.filter(e => e['Employment Type'] === 'Contractual').length;
            const projectCount = employees.filter(e => e['Employment Type'] === 'Project' || e['Position Type'] === 'Project').length;
            document.getElementById('regular-employees').textContent = regularCount;
            document.getElementById('contractual-employees').textContent = contractualCount;
            document.getElementById('project-employees').textContent = projectCount;
            
            // Turnover rate (last 365 days)
            const oneYearAgo = new Date(new Date().setDate(today.getDate() - 365));
            const leaversLastYear = employees.filter(e => {
                const leaveDate = parseDate(e['Date of Leaving']);
                return leaveDate && leaveDate >= oneYearAgo;
            }).length;
            const avgHeadcount = employees.length > 0 ? employees.length : 1;
            const turnoverRate = ((leaversLastYear / avgHeadcount) * 100).toFixed(1);
            document.getElementById('turnover-rate').textContent = turnoverRate + '%';
            
            // Recent activity
            document.getElementById('joiners-30days').textContent = employees.filter(e => parseDate(e['Date of Joining']) >= thirtyOneDaysAgo).length;
            document.getElementById('leavers-30days').textContent = employees.filter(e => parseDate(e['Date of Leaving']) >= thirtyOneDaysAgo).length;
            document.getElementById('joiners-90days').textContent = employees.filter(e => parseDate(e['Date of Joining']) >= ninetyDaysAgo).length;
            document.getElementById('leavers-90days').textContent = employees.filter(e => parseDate(e['Date of Leaving']) >= ninetyDaysAgo).length;
            
            // Render analytics charts
            renderGenderByDeptChart();
            renderEmploymentTypeChart();
            renderDeptHeadcountChart();
            renderDeptSalaryChart();
            
            const recentHires = employees.filter(e => e.Status === 'Active').sort((a, b) => parseDate(b['Date of Joining']) - parseDate(a['Date of Joining'])).slice(0, 5);
            renderTable(recentHiresTableBody, recentHires, ['Name', 'Department', 'Position', 'Status']);
        };
        
        // Chart rendering functions
        const renderGenderByDeptChart = () => {
            const deptGender = {};
            employees.forEach(emp => {
                const dept = emp.Department || 'Unassigned';
                if (!deptGender[dept]) deptGender[dept] = { Male: 0, Female: 0, Other: 0 };
                deptGender[dept][emp.Gender || 'Other']++;
            });
            
            let html = '<div style="font-size: 0.9rem;">';
            Object.entries(deptGender).sort((a, b) => (b[1].Male + b[1].Female + b[1].Other) - (a[1].Male + a[1].Female + a[1].Other)).slice(0, 6).forEach(([dept, counts]) => {
                const total = counts.Male + counts.Female + counts.Other;
                const malePercent = (counts.Male / total * 100).toFixed(0);
                const femalePercent = (counts.Female / total * 100).toFixed(0);
                html += `<div style="margin-bottom: 16px;">
                    <div style="display: flex; justify-content: space-between; margin-bottom: 4px;">
                        <span style="font-weight: 500;">${dept}</span>
                        <span style="color: var(--secondary-color);">${total} employees</span>
                    </div>
                    <div style="display: flex; gap: 2px; height: 24px; border-radius: 4px; overflow: hidden;">
                        <div style="background: #6B9BD1; width: ${malePercent}%; display: flex; align-items: center; justify-content: center; color: white; font-size: 0.75rem;">${counts.Male > 0 ? counts.Male + 'M' : ''}</div>
                        <div style="background: #CF9999; width: ${femalePercent}%; display: flex; align-items: center; justify-content: center; color: white; font-size: 0.75rem;">${counts.Female > 0 ? counts.Female + 'F' : ''}</div>
                    </div>
                    <div style="display: flex; gap: 8px; margin-top: 4px; font-size: 0.75rem; color: var(--secondary-color);">
                        <span><span style="display: inline-block; width: 10px; height: 10px; background: #6B9BD1; border-radius: 2px; margin-right: 4px;"></span>Male: ${malePercent}%</span>
                        <span><span style="display: inline-block; width: 10px; height: 10px; background: #CF9999; border-radius: 2px; margin-right: 4px;"></span>Female: ${femalePercent}%</span>
                    </div>
                </div>`;
            });
            html += '</div>';
            document.getElementById('gender-by-dept-chart').innerHTML = html;
        };
        
        const renderEmploymentTypeChart = () => {
            const types = {};
            employees.forEach(emp => {
                const type = emp['Employment Type'] || 'Unspecified';
                types[type] = (types[type] || 0) + 1;
            });
            
            const total = employees.length;
            let html = '<div style="font-size: 0.9rem;">';
            Object.entries(types).sort((a, b) => b[1] - a[1]).forEach(([type, count]) => {
                const percent = (count / total * 100).toFixed(1);
                const color = type === 'Regular' ? '#A05252' : type === 'Contractual' ? '#666666' : '#999999';
                html += `<div style="margin-bottom: 16px;">
                    <div style="display: flex; justify-content: space-between; margin-bottom: 4px;">
                        <span style="font-weight: 500;">${type}</span>
                        <span style="color: var(--secondary-color);">${count} (${percent}%)</span>
                    </div>
                    <div style="background: var(--border-color); height: 24px; border-radius: 4px; overflow: hidden;">
                        <div style="background: ${color}; width: ${percent}%; height: 100%; display: flex; align-items: center; padding-left: 8px; color: white; font-size: 0.8rem; font-weight: 500;">
                            ${percent}%
                        </div>
                    </div>
                </div>`;
            });
            html += '</div>';
            document.getElementById('employment-type-chart').innerHTML = html;
        };
        
        const renderDeptHeadcountChart = () => {
            const depts = {};
            employees.forEach(emp => {
                const dept = emp.Department || 'Unassigned';
                depts[dept] = (depts[dept] || 0) + 1;
            });
            
            const total = employees.length;
            const maxCount = Math.max(...Object.values(depts));
            let html = '<div style="font-size: 0.9rem;">';
            Object.entries(depts).sort((a, b) => b[1] - a[1]).slice(0, 5).forEach(([dept, count]) => {
                const percent = (count / total * 100).toFixed(1);
                const barWidth = (count / maxCount * 100).toFixed(1);
                html += `<div style="margin-bottom: 16px;">
                    <div style="display: flex; justify-content: space-between; margin-bottom: 4px;">
                        <span style="font-weight: 500;">${dept}</span>
                        <span style="color: var(--secondary-color);">${count} (${percent}%)</span>
                    </div>
                    <div style="background: var(--border-color); height: 28px; border-radius: 4px; overflow: hidden;">
                        <div style="background: var(--primary-color); width: ${barWidth}%; height: 100%; display: flex; align-items: center; padding-left: 8px; color: white; font-size: 0.85rem; font-weight: 500;">
                            ${count}
                        </div>
                    </div>
                </div>`;
            });
            html += '</div>';
            document.getElementById('dept-headcount-chart').innerHTML = html;
        };
        
        const renderDeptSalaryChart = () => {
            const depts = {};
            employees.filter(e => e.Status === 'Active').forEach(emp => {
                const dept = emp.Department || 'Unassigned';
                if (!depts[dept]) depts[dept] = { total: 0, count: 0 };
                depts[dept].total += parseFloat(emp['Salary'] || 0);
                depts[dept].count++;
            });
            
            const avgSalaries = Object.entries(depts).map(([dept, data]) => [dept, data.total / data.count]).sort((a, b) => b[1] - a[1]).slice(0, 5);
            const maxSalary = Math.max(...avgSalaries.map(d => d[1]));
            
            let html = '<div style="font-size: 0.9rem;">';
            avgSalaries.forEach(([dept, avgSal]) => {
                const barWidth = (avgSal / maxSalary * 100).toFixed(1);
                html += `<div style="margin-bottom: 16px;">
                    <div style="display: flex; justify-content: space-between; margin-bottom: 4px;">
                        <span style="font-weight: 500;">${dept}</span>
                        <span style="color: var(--secondary-color);">PKR ${avgSal.toLocaleString(undefined, {maximumFractionDigits: 0})}</span>
                    </div>
                    <div style="background: var(--border-color); height: 28px; border-radius: 4px; overflow: hidden;">
                        <div style="background: linear-gradient(90deg, #A05252, #CF9999); width: ${barWidth}%; height: 100%; display: flex; align-items: center; padding-left: 8px; color: white; font-size: 0.8rem; font-weight: 500;"></div>
                    </div>
                </div>`;
            });
            html += '</div>';
            document.getElementById('dept-salary-chart').innerHTML = html;
        };

        const renderEmployees = () => {
            const filters = { search: employeeSearch.value.toLowerCase(), gender: genderFilter.value, department: departmentFilter.value, status: statusFilter.value };
            const filtered = employees.filter(emp => 
                (!filters.gender || emp.Gender === filters.gender) &&
                (!filters.department || emp.Department === filters.department) &&
                (!filters.status || emp.Status === filters.status) &&
                (Object.values(emp).some(val => String(val).toLowerCase().includes(filters.search)))
            );
            
            // Update status count boxes in employees section
            document.getElementById('active-count-filter').textContent = employees.filter(e => e.Status === 'Active').length;
            document.getElementById('wfh-count-filter').textContent = employees.filter(e => e.Status === 'WFH' || e.Status === 'Work From Home').length;
            document.getElementById('annual-leave-count-filter').textContent = employees.filter(e => e.Status === 'Annual Leave').length;
            document.getElementById('short-leave-count-filter').textContent = employees.filter(e => e.Status === 'Short Leave').length;
            document.getElementById('inactive-count-filter').textContent = employees.filter(e => e.Status === 'Inactive').length;
            
            renderTable(employeesTableBody, filtered, ['Name', 'Department', 'Position', 'Status', 'Actions']);
        };

        // Function to filter by status when clicking status boxes
        function filterByStatus(status) {
            document.getElementById('status-filter').value = status;
            renderEmployees();
        }

        // Function to clear all filters
        function clearAllFilters() {
            document.getElementById('employee-search').value = '';
            document.getElementById('gender-filter').value = '';
            document.getElementById('department-filter').value = '';
            document.getElementById('status-filter').value = '';
            renderEmployees();
        }

        const renderPayroll = () => {
            renderTable(payrollTableBody, employees, ['Name', 'Department', 'Base Salary', 'Travel Allowance', 'Fuel/Grocery Allowance', 'Other Allowance', 'Provident Fund', 'EOBI', 'Total Cost to Company', 'PayrollActions']);
            
            // Calculate totals for active employees
            const activeEmps = employees.filter(e => e.Status !== 'Inactive');
            
            const totalBaseSalary = activeEmps.reduce((sum, e) => sum + parseFloat(e['Base Salary'] || 0), 0);
            const totalTravel = activeEmps.reduce((sum, e) => sum + parseFloat(e['Travel Allowance'] || 0), 0);
            const totalFuel = activeEmps.reduce((sum, e) => sum + parseFloat(e['Fuel/Grocery Allowance'] || 0), 0);
            const totalOther = activeEmps.reduce((sum, e) => sum + parseFloat(e['Other Allowance'] || 0), 0);
            const totalPF = activeEmps.reduce((sum, e) => sum + parseFloat(e['Provident Fund'] || 0), 0);
            const totalEOBI = activeEmps.reduce((sum, e) => sum + parseFloat(e['EOBI'] || 0), 0);
            const totalCTC = activeEmps.reduce((sum, e) => sum + parseFloat(e['Total Cost to Company'] || 0), 0);
            
            const totalAllowances = totalTravel + totalFuel + totalOther;
            const totalBenefits = totalPF + totalEOBI;
            
            // Update summary card
            document.getElementById('payroll-total-base').textContent = 'PKR ' + totalBaseSalary.toLocaleString(undefined, {maximumFractionDigits: 0});
            document.getElementById('payroll-total-allowances').textContent = 'PKR ' + totalAllowances.toLocaleString(undefined, {maximumFractionDigits: 0});
            document.getElementById('payroll-total-benefits').textContent = 'PKR ' + totalBenefits.toLocaleString(undefined, {maximumFractionDigits: 0});
            document.getElementById('payroll-total-ctc').textContent = 'PKR ' + totalCTC.toLocaleString(undefined, {maximumFractionDigits: 0});
        };
        
        const renderTransactions = () => {
            transactionTableBody.innerHTML = mockTransactionLog.sort((a, b) => new Date(b.date) - new Date(a.date)).map(log => `<tr><td>${new Date(log.date).toLocaleDateString()}</td><td>${log.type}</td><td>${log.employeeID}</td><td>${log.details}</td></tr>`).join('') || `<tr><td colspan="4" style="text-align: center;">No transactions recorded.</td></tr>`;
        };
        
        const renderDepartments = () => {
            // Include all employees EXCEPT Inactive
            const activeEmps = employees.filter(e => e.Status !== 'Inactive');
            console.log('Active employees for departments:', activeEmps.length);
            
            const depts = activeEmps.reduce((acc, emp) => {
                // Normalize department name - trim whitespace and handle empty values
                const deptName = (emp.Department || 'Unassigned').trim() || 'Unassigned';
                
                if (!acc[deptName]) {
                    acc[deptName] = { 
                        name: deptName, 
                        employees: [], 
                        employeeCount: 0, 
                        maleCount: 0, 
                        femaleCount: 0, 
                        wfhCount: 0, 
                        onLeaveCount: 0, 
                        totalCTC: 0 
                    };
                }
                
                acc[deptName].employees.push(emp);
                acc[deptName].employeeCount++;
                acc[deptName].totalCTC += parseFloat(emp['Total Cost to Company'] || 0);
                
                if (emp.Gender === 'Male') acc[deptName].maleCount++;
                else if (emp.Gender === 'Female') acc[deptName].femaleCount++;
                
                // Track WFH employees - check both Work Mode field and Status field
                if (emp['Work Mode'] === 'WFH' || emp['Work Mode'] === 'Hybrid' || emp.Status === 'WFH' || emp.Status === 'Work From Home') {
                    acc[deptName].wfhCount++;
                }
                
                // Track employees on leave - check both Leave Status field and Status field (case-insensitive)
                const statusLower = (emp.Status || '').toLowerCase();
                if ((emp['Leave Status'] && emp['Leave Status'] !== 'Active') || 
                    statusLower.includes('annual leave') || 
                    statusLower.includes('short leave') || 
                    statusLower.includes('on leave') || 
                    statusLower.includes('on-leave')) {
                    acc[deptName].onLeaveCount++;
                }
                
                return acc;
            }, {});
            
            console.log('Departments found:', Object.keys(depts));
            console.log('Department details:', depts);
            departmentGrid.innerHTML = Object.values(depts).map(dept => {
                const femalePercent = dept.employeeCount > 0 ? ((dept.femaleCount / dept.employeeCount) * 100).toFixed(0) : 0;
                return `<div class="card department-card" onclick="openDepartmentDetailsModal(${JSON.stringify(dept).replace(/"/g, "'")})">
                    <div class="metric-content" style="width: 100%;">
                        <h3 style="margin-bottom: 12px;">${dept.name}</h3>
                        <div style="display: flex; gap: 16px; margin-bottom: 12px;">
                            <div>
                                <div class="value" style="font-size: 2rem;">${dept.employeeCount}</div>
                                <p style="font-size: 0.85rem;">Active Employees</p>
                            </div>
                            <div style="flex: 1; padding-left: 16px; border-left: 1px solid var(--border-color);">
                                <div style="display: flex; gap: 12px; margin-bottom: 6px;">
                                    <div>
                                        <div style="font-size: 1.1rem; font-weight: 600; color: var(--primary-color);">${dept.wfhCount}</div>
                                        <p style="font-size: 0.75rem; color: var(--secondary-color);">WFH</p>
                                    </div>
                                    <div>
                                        <div style="font-size: 1.1rem; font-weight: 600; color: var(--primary-color);">${dept.onLeaveCount}</div>
                                        <p style="font-size: 0.75rem; color: var(--secondary-color);">On Leave</p>
                                    </div>
                                </div>
                                <div style="display: flex; gap: 12px; margin-bottom: 6px;">
                                    <div>
                                        <div style="font-size: 1.3rem; font-weight: 600; color: #6B9BD1;">${dept.maleCount}</div>
                                        <p style="font-size: 0.75rem; color: var(--secondary-color);">Male</p>
                                    </div>
                                    <div>
                                        <div style="font-size: 1.3rem; font-weight: 600; color: #CF9999;">${dept.femaleCount}</div>
                                        <p style="font-size: 0.75rem; color: var(--secondary-color);">Female</p>
                                    </div>
                                </div>
                                <div style="display: flex; gap: 2px; height: 8px; border-radius: 4px; overflow: hidden;">
                                    <div style="background: #6B9BD1; width: ${100 - femalePercent}%;"></div>
                                    <div style="background: #CF9999; width: ${femalePercent}%;"></div>
                                </div>
                            </div>
                        </div>
                        <div style="padding-top: 12px; border-top: 1px solid var(--border-color);">
                            <p style="color: var(--secondary-color); margin-bottom: 4px; font-size: 0.85rem;">Total Department Cost</p>
                            <div style="font-weight: 700; color: var(--primary-color); font-size: 1.5rem;">PKR ${dept.totalCTC.toLocaleString(undefined, {maximumFractionDigits: 0})}</div>
                        </div>
                    </div>
                </div>`;
            }).join('');
        };

        function renderTable(tableBody, data, columns) {
            tableBody.innerHTML = '';
            if (data.length === 0) { tableBody.innerHTML = `<tr><td colspan="${columns.length}" style="text-align:center; padding: 20px;">No data available.</td></tr>`; return; }
            data.forEach((employee) => {
                const row = document.createElement('tr');
                const originalIndex = employees.findIndex(e => e.ID === employee.ID);
                columns.forEach(col => {
                    const cell = document.createElement('td');
                    if (col === 'Name') cell.innerHTML = `<a href="#" onclick="openDetailsModal(employees[${originalIndex}])">${employee[col]}</a>`;
                    else if (col === 'Status') cell.innerHTML = `<span class="status-badge status-${(employee[col] || '').toLowerCase().replace('-', '')}">${employee[col] || 'N/A'}</span>`;
                    else if (col === 'Actions') cell.innerHTML = `<div class="table-actions"><button onclick="openEmployeeModal(employees[${originalIndex}])" title="Edit"><i class="fas fa-edit"></i></button><button onclick="deleteEmployee(${originalIndex})" title="Delete"><i class="fas fa-trash"></i></button></div>`;
                    else if (col === 'PayrollActions') cell.innerHTML = `<div class="table-actions"><button onclick="openPayrollModal(employees[${originalIndex}], ${originalIndex})" title="Edit Payroll"><i class="fas fa-pencil-alt"></i></button></div>`;
                    else if (['Base Salary', 'Total Cost to Company'].includes(col)) cell.textContent = `PKR ${parseFloat(employee[col] || 0).toLocaleString()}`;
                    else cell.textContent = employee[col] || 'N/A';
                    row.appendChild(cell);
                });
                tableBody.appendChild(row);
            });
        }
        
        // --- Form/Filter Population ---
        const populateFilters = () => {
            const departments = [...new Set(employees.map(emp => emp.Department).filter(Boolean))];
            departmentFilter.innerHTML = '<option value="">All Departments</option>' + departments.map(dept => `<option value="${dept}">${dept}</option>`).join('');
        };
        const populateReportDepartments = () => {
            const departments = [...new Set(employees.map(emp => emp.Department).filter(Boolean))];
            reportDepartmentSelect.innerHTML = '<option value="">All Departments</option>' + departments.map(dept => `<option value="${dept}">${dept}</option>`).join('');
        };
        const populateTransactionEmployees = () => {
            transactionEmployeeSelect.innerHTML = '<option value="">Select Employee...</option>' + employees.map(emp => `<option value="${emp.ID}">${emp.Name} (${emp.ID})</option>`).join('');
        };

        // --- Data Utility & Calculations ---
        const parseCSV = text => {
            const lines = text.split('\n').filter(line => line.trim());
            if (lines.length < 2) return [];
            const headers = lines[0].split(/,(?=(?:(?:[^"]*"){2})*[^"]*$)/).map(h => h.trim().replace(/^"|"$/g, ''));
            return lines.slice(1).map(line => {
                const values = line.split(/,(?=(?:(?:[^"]*"){2})*[^"]*$)/).map(v => v.trim().replace(/^"|"$/g, ''));
                if (values.length !== headers.length) return null;
                return headers.reduce((obj, header, i) => {
                    obj[header] = values[i];
                    return obj;
                }, {});
            }).filter(Boolean);
        };
        const calculateTotalCost = employee => {
            const sumFields = (fields) => fields.reduce((acc, field) => acc + parseFloat(employee[field] || 0), 0);
            const salary = sumFields(['Base Salary', 'Travel Allowance', 'Fuel/Grocery Allowance', 'Other Allowance']);
            const totalCost = salary + sumFields(['Provident Fund', 'EOBI']);
            return { salary, totalCost };
        };
        const parseDate = dateStr => dateStr ? new Date(dateStr) : null;
        
        // --- Event Listeners ---
        document.addEventListener('DOMContentLoaded', () => {
            showPage('dashboard');
            themeToggleBtn.addEventListener('click', () => {
                body.classList.toggle('dark-theme');
                localStorage.setItem('theme', body.classList.contains('dark-theme') ? 'dark' : 'light');
                themeToggleBtn.innerHTML = body.classList.contains('dark-theme') ? '<i class="fas fa-sun"></i>' : '<i class="fas fa-moon"></i>';
                updateUI();
            });
            navLinks.forEach(link => link.addEventListener('click', e => { e.preventDefault(); showPage(link.dataset.page); }));
            [employeeSearch, genderFilter, departmentFilter, statusFilter].forEach(el => el.addEventListener('input', renderEmployees));
            window.addEventListener('click', e => { if (e.target.classList.contains('modal')) e.target.style.display = 'none'; });
            
            employeeForm.addEventListener('submit', handleEmployeeFormSubmit);
            payrollForm.addEventListener('submit', handlePayrollFormSubmit);
            transactionForm.addEventListener('submit', handleTransactionFormSubmit);
            reportForm.addEventListener('submit', handleReportFormSubmit);
            
            document.querySelectorAll('.tab-button').forEach(button => {
                button.addEventListener('click', e => {
                    document.querySelectorAll('.tab-content, .tab-button').forEach(el => el.classList.remove('active'));
                    document.getElementById(`tab-${e.target.dataset.tab}`).classList.add('active');
                    e.target.classList.add('active');
                });
            });

            employeeProfilePicInput.addEventListener('change', e => {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = e => { profilePicPreview.src = e.target.result; profilePicPreview.style.display = 'block'; };
                    reader.readAsDataURL(file);
                }
            });

            // Load data from Google Sheets on page load
            loadDataFromGoogleSheets();
        });

        // --- Form Handlers ---
        function handleEmployeeFormSubmit(e) {
            e.preventDefault();
            const formData = new FormData(employeeForm);
            const employeeData = Object.fromEntries(formData.entries());
            ['Date of Joining', 'Date of Leaving'].forEach(key => {
                if (employeeData[key]) employeeData[key] = new Date(employeeData[key]).toLocaleDateString('en-US');
            });
            const { salary, totalCost } = calculateTotalCost(employeeData);
            employeeData['Salary'] = salary.toFixed(2);
            employeeData['Total Cost to Company'] = totalCost.toFixed(2);
            employeeData.ProfilePic = profilePicPreview.src;
            
            const index = formData.get('index');
            if (index) {
                employees[index] = { ...employees[index], ...employeeData };
            } else {
                employees.push(employeeData);
                mockTransactionLog.push({ date: new Date(), type: 'NEW HIRE', employeeID: employeeData.ID, details: `Hired as ${employeeData.Position}.` });
            }
            closeEmployeeModal();
            updateUI();
        }

        function handlePayrollFormSubmit(e) {
            e.preventDefault();
            const formData = new FormData(payrollForm);
            const index = formData.get('index');
            if (index === '' || !employees[index]) return;
            const employee = employees[index];
            ['Base Salary', 'Travel Allowance', 'Fuel/Grocery Allowance', 'Other Allowance', 'Provident Fund', 'EOBI'].forEach(key => {
                employee[key] = formData.get(key);
            });
            const { salary, totalCost } = calculateTotalCost(employee);
            employee['Salary'] = salary.toFixed(2);
            employee['Total Cost to Company'] = totalCost.toFixed(2);
            closePayrollModal();
            updateUI();
        }

        function handleTransactionFormSubmit(e) {
            e.preventDefault();
            const formData = new FormData(transactionForm);
            const type = formData.get('type');
            const employeeId = formData.get('employee_id');
            const employeeIndex = employees.findIndex(emp => emp.ID === employeeId);
            const employee = employees[employeeIndex];
            const notes = formData.get('notes');
            const date = formData.get('effective_date');

            if (!employee) { return; }

            let details = '';
            if (type === 'promotion') {
                employee['Base Salary'] = formData.get('new_salary');
                employee.Position = formData.get('new_position');
                details = `Promoted to ${employee.Position} with new salary.`;
            } else if (type === 'termination') {
                employee.Status = 'Inactive';
                employee['Date of Leaving'] = new Date(formData.get('termination_date')).toLocaleDateString('en-US');
                employee['Termination Reason'] = formData.get('termination_reason');
                details = `Terminated. Reason: ${employee['Termination Reason']}.`;
            } else if (type === 'lwp') {
                details = `LWP from ${new Date(formData.get('lwp_start_date')).toLocaleDateString('en-US')} to ${new Date(formData.get('lwp_end_date')).toLocaleDateString('en-US')}.`;
            }
            const { salary, totalCost } = calculateTotalCost(employee);
            employee['Salary'] = salary.toFixed(2);
            employee['Total Cost to Company'] = totalCost.toFixed(2);
            
            mockTransactionLog.push({ date, type: type.toUpperCase(), employeeID: employeeId, details, notes });
            closeTransactionModal();
            updateUI();
        }
        
        function handleReportFormSubmit(e) {
            e.preventDefault();
            const formData = new FormData(reportForm);
            const reportType = formData.get('reportType');
            const department = formData.get('department');
            const status = formData.get('status');
            const gender = formData.get('gender');
            const startDate = parseDate(formData.get('startDate'));
            const endDate = parseDate(formData.get('endDate'));
            
            let filteredData = employees.filter(emp => {
                let match = true;
                if (department) match = match && emp.Department === department;
                if (status) match = match && emp.Status === status;
                if (gender) match = match && emp.Gender === gender;
                return match;
            });
            
            let columns, analyticsHtml = '';
            
            if (reportType === 'joining') {
                filteredData = filteredData.filter(emp => { const d = parseDate(emp['Date of Joining']); return (!startDate || d >= startDate) && (!endDate || d <= endDate); });
                columns = ['ID', 'Name', 'Department', 'Position', 'Gender', 'Date of Joining', 'Status'];
                
                // Analytics
                const byDept = {};
                filteredData.forEach(emp => {
                    const dept = emp.Department || 'Unassigned';
                    byDept[dept] = (byDept[dept] || 0) + 1;
                });
                analyticsHtml = `<div style="background: var(--background-color); padding: 16px; border-radius: 8px; margin-bottom: 16px;">
                    <h4 style="margin-bottom: 12px; color: var(--primary-color);">Analytics Summary</h4>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px;">
                        <div><strong>Total Joiners:</strong> ${filteredData.length}</div>
                        <div><strong>Most Hiring Dept:</strong> ${Object.entries(byDept).sort((a,b) => b[1] - a[1])[0]?.[0] || 'N/A'}</div>
                        <div><strong>Male:</strong> ${filteredData.filter(e => e.Gender === 'Male').length}</div>
                        <div><strong>Female:</strong> ${filteredData.filter(e => e.Gender === 'Female').length}</div>
                    </div>
                </div>`;
                
            } else if (reportType === 'leaving') {
                filteredData = filteredData.filter(emp => { const d = parseDate(emp['Date of Leaving']); return emp.Status === 'Inactive' && (!startDate || d >= startDate) && (!endDate || d <= endDate); });
                columns = ['ID', 'Name', 'Department', 'Position', 'Date of Joining', 'Date of Leaving', 'Tenure (Years)', 'Termination Reason'];
                
                // Calculate tenure
                filteredData = filteredData.map(emp => {
                    const doj = parseDate(emp['Date of Joining']);
                    const dol = parseDate(emp['Date of Leaving']);
                    const tenure = doj && dol ? ((dol - doj) / (365.25 * 24 * 60 * 60 * 1000)).toFixed(1) : 'N/A';
                    return { ...emp, 'Tenure (Years)': tenure };
                });
                
                // Analytics
                const avgTenure = filteredData.reduce((sum, emp) => sum + (parseFloat(emp['Tenure (Years)']) || 0), 0) / filteredData.length;
                analyticsHtml = `<div style="background: var(--background-color); padding: 16px; border-radius: 8px; margin-bottom: 16px;">
                    <h4 style="margin-bottom: 12px; color: var(--primary-color);">Turnover Analytics</h4>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px;">
                        <div><strong>Total Leavers:</strong> ${filteredData.length}</div>
                        <div><strong>Avg Tenure:</strong> ${avgTenure.toFixed(1)} years</div>
                        <div><strong>Voluntary:</strong> ${filteredData.filter(e => e['Termination Reason']?.includes('Resign')).length}</div>
                        <div><strong>Involuntary:</strong> ${filteredData.filter(e => e['Termination Reason']?.includes('Termin')).length}</div>
                    </div>
                </div>`;
                
            } else if (reportType === 'payroll') {
                filteredData = filteredData.filter(emp => emp.Status === 'Active');
                columns = ['ID', 'Name', 'Department', 'Position', 'Base Salary', 'Travel Allowance', 'Fuel/Grocery Allowance', 'Other Allowance', 'Provident Fund', 'EOBI', 'Total Cost to Company'];
                
                // Analytics
                const totalPayroll = filteredData.reduce((sum, emp) => sum + parseFloat(emp['Total Cost to Company'] || 0), 0);
                const avgSalary = totalPayroll / filteredData.length;
                analyticsHtml = `<div style="background: var(--background-color); padding: 16px; border-radius: 8px; margin-bottom: 16px;">
                    <h4 style="margin-bottom: 12px; color: var(--primary-color);">Payroll Summary</h4>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px;">
                        <div><strong>Total Employees:</strong> ${filteredData.length}</div>
                        <div><strong>Total Payroll:</strong> PKR ${totalPayroll.toLocaleString(undefined, {maximumFractionDigits: 0})}</div>
                        <div><strong>Avg Cost/Employee:</strong> PKR ${avgSalary.toLocaleString(undefined, {maximumFractionDigits: 0})}</div>
                        <div><strong>Highest Paid Dept:</strong> ${(() => {
                            const deptTotals = {};
                            filteredData.forEach(e => {
                                const d = e.Department || 'Unassigned';
                                deptTotals[d] = (deptTotals[d] || 0) + parseFloat(e['Total Cost to Company'] || 0);
                            });
                            return Object.entries(deptTotals).sort((a,b) => b[1] - a[1])[0]?.[0] || 'N/A';
                        })()}</div>
                    </div>
                </div>`;
                
            } else if (reportType === 'contact') {
                columns = ['ID', 'Name', 'Department', 'Position', 'Contact Number', 'Email', 'Address', 'Emergency Phone'];
                
            } else if (reportType === 'employee-status') {
                columns = ['ID', 'Name', 'Department', 'Position', 'Status', 'Work Mode', 'Leave Status'];
                
                // Analytics
                const statusCount = {};
                filteredData.forEach(emp => {
                    const s = emp.Status || 'Unknown';
                    statusCount[s] = (statusCount[s] || 0) + 1;
                });
                analyticsHtml = `<div style="background: var(--background-color); padding: 16px; border-radius: 8px; margin-bottom: 16px;">
                    <h4 style="margin-bottom: 12px; color: var(--primary-color);">Status Distribution</h4>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 12px;">
                        ${Object.entries(statusCount).map(([status, count]) => 
                            `<div><strong>${status}:</strong> ${count} (${((count/filteredData.length)*100).toFixed(1)}%)</div>`
                        ).join('')}
                    </div>
                </div>`;
                
            } else if (reportType === 'tenure-analysis') {
                filteredData = filteredData.filter(emp => emp.Status === 'Active');
                columns = ['ID', 'Name', 'Department', 'Position', 'Date of Joining', 'Tenure (Years)', 'Tenure Category'];
                
                // Calculate tenure
                const today = new Date();
                filteredData = filteredData.map(emp => {
                    const doj = parseDate(emp['Date of Joining']);
                    const tenure = doj ? ((today - doj) / (365.25 * 24 * 60 * 60 * 1000)).toFixed(1) : 'N/A';
                    let category = 'New (0-1 year)';
                    if (tenure > 5) category = 'Veteran (5+ years)';
                    else if (tenure > 3) category = 'Experienced (3-5 years)';
                    else if (tenure > 1) category = 'Mid-level (1-3 years)';
                    return { ...emp, 'Tenure (Years)': tenure, 'Tenure Category': category };
                });
                
                // Analytics
                const categories = {};
                filteredData.forEach(emp => {
                    const cat = emp['Tenure Category'];
                    categories[cat] = (categories[cat] || 0) + 1;
                });
                analyticsHtml = `<div style="background: var(--background-color); padding: 16px; border-radius: 8px; margin-bottom: 16px;">
                    <h4 style="margin-bottom: 12px; color: var(--primary-color);">Tenure Analysis</h4>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 12px;">
                        ${Object.entries(categories).map(([cat, count]) => 
                            `<div><strong>${cat}:</strong> ${count} employees</div>`
                        ).join('')}
                    </div>
                </div>`;
                
            } else if (reportType === 'department-salary') {
                filteredData = filteredData.filter(emp => emp.Status === 'Active');
                const totalOrgCost = filteredData.reduce((sum, emp) => sum + parseFloat(emp['Total Cost to Company'] || 0), 0);
                
                const deptTotals = {};
                filteredData.forEach(emp => {
                    const dept = emp.Department || 'Unassigned';
                    if (!deptTotals[dept]) deptTotals[dept] = 0;
                    deptTotals[dept] += parseFloat(emp['Total Cost to Company'] || 0);
                });
                
                filteredData = filteredData.map(emp => {
                    const deptTotal = deptTotals[emp.Department || 'Unassigned'];
                    const deptPercent = deptTotal > 0 ? ((parseFloat(emp['Total Cost to Company'] || 0) / deptTotal) * 100).toFixed(2) : '0.00';
                    const orgPercent = totalOrgCost > 0 ? ((parseFloat(emp['Total Cost to Company'] || 0) / totalOrgCost) * 100).toFixed(2) : '0.00';
                    return {
                        ...emp,
                        '% of Dept Cost': deptPercent + '%',
                        '% of Total Cost': orgPercent + '%'
                    };
                });
                
                filteredData.sort((a, b) => {
                    if (a.Department !== b.Department) return (a.Department || 'Unassigned').localeCompare(b.Department || 'Unassigned');
                    return parseFloat(b['Total Cost to Company'] || 0) - parseFloat(a['Total Cost to Company'] || 0);
                });
                
                columns = ['Department', 'Name', 'Position', 'Base Salary', 'Travel Allowance', 'Fuel/Grocery Allowance', 'Other Allowance', 'Provident Fund', 'EOBI', 'Total Cost to Company', '% of Dept Cost', '% of Total Cost'];
                
                // Analytics by department
                analyticsHtml = `<div style="background: var(--background-color); padding: 16px; border-radius: 8px; margin-bottom: 16px;">
                    <h4 style="margin-bottom: 12px; color: var(--primary-color);">Department Cost Analysis</h4>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 12px;">
                        ${Object.entries(deptTotals).sort((a,b) => b[1] - a[1]).map(([dept, cost]) => 
                            `<div><strong>${dept}:</strong> PKR ${cost.toLocaleString(undefined, {maximumFractionDigits: 0})} (${((cost/totalOrgCost)*100).toFixed(1)}%)</div>`
                        ).join('')}
                    </div>
                </div>`;
                
            } else if (reportType === 'salary-distribution') {
                filteredData = filteredData.filter(emp => emp.Status === 'Active');
                columns = ['Salary Range', 'Count', 'Percentage', 'Total Cost'];
                
                const ranges = {
                    'Under 50K': { min: 0, max: 50000, count: 0, cost: 0 },
                    '50K - 100K': { min: 50000, max: 100000, count: 0, cost: 0 },
                    '100K - 150K': { min: 100000, max: 150000, count: 0, cost: 0 },
                    '150K - 200K': { min: 150000, max: 200000, count: 0, cost: 0 },
                    'Over 200K': { min: 200000, max: Infinity, count: 0, cost: 0 }
                };
                
                filteredData.forEach(emp => {
                    const cost = parseFloat(emp['Total Cost to Company'] || 0);
                    Object.values(ranges).forEach(range => {
                        if (cost >= range.min && cost < range.max) {
                            range.count++;
                            range.cost += cost;
                        }
                    });
                });
                
                const total = filteredData.length;
                filteredData = Object.entries(ranges).map(([name, data]) => ({
                    'Salary Range': name,
                    'Count': data.count,
                    'Percentage': ((data.count / total) * 100).toFixed(1) + '%',
                    'Total Cost': 'PKR ' + data.cost.toLocaleString(undefined, {maximumFractionDigits: 0})
                }));
                
            } else if (reportType === 'allowances-breakdown') {
                filteredData = filteredData.filter(emp => emp.Status === 'Active');
                columns = ['ID', 'Name', 'Department', 'Base Salary', 'Travel Allowance', 'Fuel/Grocery Allowance', 'Other Allowance', 'Total Allowances', '% of Base'];
                
                filteredData = filteredData.map(emp => {
                    const base = parseFloat(emp['Base Salary'] || 0);
                    const travel = parseFloat(emp['Travel Allowance'] || 0);
                    const fuel = parseFloat(emp['Fuel/Grocery Allowance'] || 0);
                    const other = parseFloat(emp['Other Allowance'] || 0);
                    const totalAllowances = travel + fuel + other;
                    const percent = base > 0 ? ((totalAllowances / base) * 100).toFixed(1) : '0.0';
                    return { ...emp, 'Total Allowances': totalAllowances, '% of Base': percent + '%' };
                });
                
            } else if (reportType === 'gender-analytics') {
                columns = ['Department', 'Male', 'Female', 'Total', 'Female %', 'Gender Diversity Score'];
                
                const deptGender = {};
                filteredData.forEach(emp => {
                    const dept = emp.Department || 'Unassigned';
                    if (!deptGender[dept]) deptGender[dept] = { male: 0, female: 0 };
                    if (emp.Gender === 'Male') deptGender[dept].male++;
                    if (emp.Gender === 'Female') deptGender[dept].female++;
                });
                
                filteredData = Object.entries(deptGender).map(([dept, counts]) => {
                    const total = counts.male + counts.female;
                    const femalePercent = total > 0 ? ((counts.female / total) * 100).toFixed(1) : '0.0';
                    // Diversity score: closer to 50/50 = higher score
                    const diversityScore = total > 0 ? (100 - Math.abs(50 - parseFloat(femalePercent))).toFixed(1) : '0.0';
                    return {
                        'Department': dept,
                        'Male': counts.male,
                        'Female': counts.female,
                        'Total': total,
                        'Female %': femalePercent + '%',
                        'Gender Diversity Score': diversityScore
                    };
                }).sort((a, b) => b.Total - a.Total);
                
            } else if (reportType === 'turnover-analysis') {
                const activeEmps = employees.filter(e => e.Status === 'Active');
                const inactiveEmps = employees.filter(e => e.Status === 'Inactive');
                
                columns = ['Metric', 'Value'];
                
                const today = new Date();
                const lastYear = new Date(today.getFullYear() - 1, today.getMonth(), today.getDate());
                const leaversLastYear = inactiveEmps.filter(emp => {
                    const dol = parseDate(emp['Date of Leaving']);
                    return dol && dol >= lastYear;
                });
                
                const turnoverRate = activeEmps.length > 0 ? ((leaversLastYear.length / activeEmps.length) * 100).toFixed(1) : '0.0';
                
                filteredData = [
                    { 'Metric': 'Current Active Employees', 'Value': activeEmps.length },
                    { 'Metric': 'Total Inactive Employees', 'Value': inactiveEmps.length },
                    { 'Metric': 'Leavers in Last 12 Months', 'Value': leaversLastYear.length },
                    { 'Metric': 'Annual Turnover Rate', 'Value': turnoverRate + '%' },
                    { 'Metric': 'Retention Rate', 'Value': (100 - parseFloat(turnoverRate)).toFixed(1) + '%' },
                    { 'Metric': 'Avg Tenure of Leavers', 'Value': (() => {
                        const avgTenure = leaversLastYear.reduce((sum, emp) => {
                            const doj = parseDate(emp['Date of Joining']);
                            const dol = parseDate(emp['Date of Leaving']);
                            const tenure = doj && dol ? ((dol - doj) / (365.25 * 24 * 60 * 60 * 1000)) : 0;
                            return sum + tenure;
                        }, 0) / (leaversLastYear.length || 1);
                        return avgTenure.toFixed(1) + ' years';
                    })() }
                ];
                
            } else if (reportType === 'work-mode-analysis') {
                filteredData = filteredData.filter(emp => emp.Status === 'Active');
                columns = ['Department', 'Office', 'WFH', 'Hybrid', 'On Leave', 'Total'];
                
                const deptWorkMode = {};
                filteredData.forEach(emp => {
                    const dept = emp.Department || 'Unassigned';
                    if (!deptWorkMode[dept]) deptWorkMode[dept] = { office: 0, wfh: 0, hybrid: 0, leave: 0 };
                    
                    const workMode = emp['Work Mode'] || 'Office';
                    const leaveStatus = emp['Leave Status'] || 'Active';
                    
                    if (leaveStatus !== 'Active') deptWorkMode[dept].leave++;
                    else if (workMode === 'WFH') deptWorkMode[dept].wfh++;
                    else if (workMode === 'Hybrid') deptWorkMode[dept].hybrid++;
                    else deptWorkMode[dept].office++;
                });
                
                filteredData = Object.entries(deptWorkMode).map(([dept, modes]) => {
                    const total = modes.office + modes.wfh + modes.hybrid + modes.leave;
                    return {
                        'Department': dept,
                        'Office': modes.office,
                        'WFH': modes.wfh,
                        'Hybrid': modes.hybrid,
                        'On Leave': modes.leave,
                        'Total': total
                    };
                }).sort((a, b) => b.Total - a.Total);
                
            } else if (reportType === 'provident-fund') {
                filteredData = filteredData.filter(emp => emp.Status === 'Active');
                columns = ['ID', 'Name', 'Department', 'Base Salary', 'PF Contribution', 'Monthly PF'];
                
                filteredData = filteredData.map(emp => {
                    const baseSalary = parseFloat(emp['Base Salary'] || 0);
                    const pfRate = 10; // 10% of base salary
                    const monthlyPF = (baseSalary * pfRate / 100);
                    return {
                        ...emp,
                        'PF Contribution': pfRate + '%',
                        'Monthly PF': 'PKR ' + monthlyPF.toLocaleString(undefined, {maximumFractionDigits: 0})
                    };
                });
                
                const totalPF = filteredData.reduce((sum, emp) => {
                    return sum + parseFloat(emp['Monthly PF'].replace('PKR ', '').replace(/,/g, ''));
                }, 0);
                
                analyticsHtml = `<div style="background: var(--background-color); padding: 16px; border-radius: 8px; margin-bottom: 16px;">
                    <h4 style="margin-bottom: 12px; color: var(--primary-color);">PF Summary</h4>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px;">
                        <div><strong>Total Employees:</strong> ${filteredData.length}</div>
                        <div><strong>Monthly PF Total:</strong> PKR ${totalPF.toLocaleString(undefined, {maximumFractionDigits: 0})}</div>
                        <div><strong>Annual PF Total:</strong> PKR ${(totalPF * 12).toLocaleString(undefined, {maximumFractionDigits: 0})}</div>
                    </div>
                </div>`;
                
            } else if (reportType === 'eobi-report') {
                filteredData = filteredData.filter(emp => emp.Status === 'Active');
                columns = ['ID', 'Name', 'Department', 'EOBI Contribution'];
                
                const eobi = 2550; // Fixed EOBI amount
                filteredData = filteredData.map(emp => ({
                    ...emp,
                    'EOBI Contribution': 'PKR ' + eobi.toLocaleString()
                }));
                
                analyticsHtml = `<div style="background: var(--background-color); padding: 16px; border-radius: 8px; margin-bottom: 16px;">
                    <h4 style="margin-bottom: 12px; color: var(--primary-color);">EOBI Summary</h4>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px;">
                        <div><strong>Total Employees:</strong> ${filteredData.length}</div>
                        <div><strong>Monthly EOBI Total:</strong> PKR ${(eobi * filteredData.length).toLocaleString()}</div>
                        <div><strong>Annual EOBI Total:</strong> PKR ${(eobi * filteredData.length * 12).toLocaleString()}</div>
                    </div>
                </div>`;
            }
            
            mockReportData = filteredData;
            reportOutputContent.innerHTML = analyticsHtml + generateReportTableHTML(filteredData, columns);
            downloadReportBtn.style.display = filteredData.length > 0 ? 'flex' : 'none';
        }

        function deleteEmployee(index) {
             if (confirm('Are you sure you want to delete this employee?')) {
                employees.splice(index, 1);
                updateUI();
            }
        }

        function fillEmployeeForm(employee) {
            document.getElementById('employee-index').value = employees.indexOf(employee);
            Object.keys(employee).forEach(key => {
                const element = employeeForm.querySelector(`[name="${key}"]`);
                if (element) {
                    if (element.type === 'date') {
                        element.value = employee[key] ? new Date(employee[key]).toISOString().split('T')[0] : '';
                    } else {
                        element.value = employee[key];
                    }
                }
            });
            if (employee.ProfilePic) {
                profilePicPreview.src = employee.ProfilePic;
                profilePicPreview.style.display = 'block';
            }
            document.querySelector('#employee-modal h3').textContent = 'Edit Employee';
        }

        function openPayrollModal(employee, index) {
            document.getElementById('payroll-employee-index').value = index;
            document.getElementById('payroll-name').value = employee.Name;
            document.getElementById('payroll-salary').value = parseFloat(employee['Base Salary'] || 0);
            document.getElementById('payroll-travel').value = parseFloat(employee['Travel Allowance'] || 0);
            document.getElementById('payroll-fuel').value = parseFloat(employee['Fuel/Grocery Allowance'] || 0);
            document.getElementById('payroll-other').value = parseFloat(employee['Other Allowance'] || 0);
            document.getElementById('payroll-pf').value = parseFloat(employee['Provident Fund'] || 0);
            document.getElementById('payroll-eobi').value = parseFloat(employee['EOBI'] || 0);
            
            // Calculate and display CTC preview
            updatePayrollCTCPreview();
            
            // Add event listeners for live CTC calculation
            ['payroll-salary', 'payroll-travel', 'payroll-fuel', 'payroll-other', 'payroll-pf', 'payroll-eobi'].forEach(fieldId => {
                document.getElementById(fieldId).addEventListener('input', updatePayrollCTCPreview);
            });
            
            payrollModal.style.display = 'flex';
        }
        
        function updatePayrollCTCPreview() {
            const baseSalary = parseFloat(document.getElementById('payroll-salary').value || 0);
            const travel = parseFloat(document.getElementById('payroll-travel').value || 0);
            const fuel = parseFloat(document.getElementById('payroll-fuel').value || 0);
            const other = parseFloat(document.getElementById('payroll-other').value || 0);
            const pf = parseFloat(document.getElementById('payroll-pf').value || 0);
            const eobi = parseFloat(document.getElementById('payroll-eobi').value || 0);
            
            const totalCTC = baseSalary + travel + fuel + other + pf + eobi;
            document.getElementById('payroll-ctc-preview').textContent = 'PKR ' + totalCTC.toLocaleString(undefined, {maximumFractionDigits: 0});
        }
        
        function updateTransactionForm(type) {
            let fieldsHtml = '<div class="form-grid">';
            if (type === 'promotion') {
                fieldsHtml += `<div class="form-group"><label>New Position</label><input type="text" name="new_position" required></div><div class="form-group"><label>New Base Salary</label><input type="number" name="new_salary" required></div>`;
            } else if (type === 'lwp') {
                fieldsHtml += `<div class="form-group"><label>LWP Start Date</label><input type="date" name="lwp_start_date" required></div><div class="form-group"><label>LWP End Date</label><input type="date" name="lwp_end_date" required></div>`;
            } else if (type === 'termination') {
                fieldsHtml += `<div class="form-group"><label>Termination Reason</label><input type="text" name="termination_reason" required></div><div class="form-group"><label>Date of Leaving</label><input type="date" name="termination_date" required></div>`;
            }
            fieldsHtml += '</div>';
            dynamicTransactionFields.innerHTML = fieldsHtml;
        }

        function dataToCSV(data, filename) {
            if (data.length === 0) return;
            const headers = Object.keys(data[0]);
            const csvRows = [headers.join(','), ...data.map(row => headers.map(header => `"${(row[header] || '').toString().replace(/"/g, '""')}"`).join(','))];
            const blob = new Blob([csvRows.join('\n')], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = filename;
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        function downloadReport() { dataToCSV(mockReportData, `HR_Report_${new Date().toISOString().slice(0, 10)}.csv`); }
        function downloadTransactionLog() { dataToCSV(mockTransactionLog, `HR_Transaction_Log_${new Date().toISOString().slice(0, 10)}.csv`); }
        
        function generateReportTableHTML(data, columns) {
            if (data.length === 0) return '<p>No records found.</p>';
            const currencyFields = ['Base Salary', 'Travel Allowance', 'Fuel/Grocery Allowance', 'Other Allowance', 'Provident Fund', 'EOBI', 'Salary', 'Total Cost to Company'];
            let head = `<thead><tr>${columns.map(c => `<th>${c}</th>`).join('')}</tr></thead>`;
            let body = `<tbody>${data.map(row => `<tr>${columns.map(c => {
                let value = row[c] || '';
                // Format currency fields
                if (currencyFields.includes(c) && value && !isNaN(parseFloat(value))) {
                    value = 'PKR ' + parseFloat(value).toLocaleString(undefined, {maximumFractionDigits: 0});
                }
                return `<td>${value}</td>`;
            }).join('')}</tr>`).join('')}</tbody>`;
            return `<div class="table-responsive"><table>${head}${body}</table></div>`;
        }
    </script>
</body>
</html>
